<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Interactivo - AZ-104</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        html {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-900 */
        }
        html.dark {
            background-color: #111827; /* bg-gray-900 */
            color: #f9fafb; /* text-gray-100 */
        }
        .option-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .correct {
            background-color: #16a34a !important; /* green-600 */
            border-color: #16a34a !important;
            color: white !important;
        }
        .incorrect {
            background-color: #dc2626 !important; /* red-600 */
            border-color: #dc2626 !important;
            color: white !important;
        }
        .selected {
            border-color: #2563eb; /* blue-600 */
            background-color: #dbeafe; /* blue-100 */
        }
        .dark .selected {
            background-color: #1e3a8a; /* blue-900 */
        }
        .feedback {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.4s ease-in-out,
                        transform 0.4s ease-in-out;
            opacity: 0;
            transform: translateY(-10px);
        }
        .feedback.show {
            max-height: 300px;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            opacity: 1;
            transform: translateY(0);
        }
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .marked {
            color: #f59e0b; /* amber-500 */
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        .progress-bar-container {
            width: 100%;
            height: 1.25rem;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .dark .progress-bar-container {
            background-color: #374151; /* gray-700 */
        }
        .progress-bar {
            height: 100%;
            background-color: #2563eb; /* blue-600 */
            transition: width 0.4s ease-in-out;
            text-align: center;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .category-progress {
            background-color: #dbeafe; /* blue-100 */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .dark .category-progress {
            background-color: #1e40af; /* blue-800 asd*/
        }
        .category-progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 0.5rem;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
    </style>
    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.95);}
            to { opacity: 1; transform: scale(1);}
        }
        .animate-fade-in {
            animation: fade-in 0.4s ease;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <!-- Sección de login -->
    <div id="login-section" style="text-align:center; margin-top:40px;">
      <div style="font-weight:bold; color:#b91c1c; font-size:1.3em; margin-bottom:20px;">&lt;&lt;&lt;&lt; Acceso Restringido &gt;&gt;&gt;&gt;</div>
      <button onclick="loginGoogle()" style="padding:10px 20px; font-size:1.2em; background:#2563eb; color:white; border-radius:8px;">Iniciar sesión con Google</button>
    </div>
    <!-- Modal de selección de cantidad de preguntas -->
    <div id="quantity-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-10 animate-fade-in text-center">
        <h2 class="text-2xl font-bold mb-6 text-blue-700 dark:text-blue-300">¿Cuántas preguntas quieres responder?</h2>
        <div id="quantity-buttons" class="flex flex-wrap gap-4 justify-center mb-6">
          <button data-quantity="10" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all text-lg shadow-md">10</button>
          <button data-quantity="30" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all text-lg shadow-md">30</button>
          <button data-quantity="60" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all text-lg shadow-md">60</button>
          <button data-quantity="100" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all text-lg shadow-md">100</button>
        </div>
      </div>
    </div>
    <!-- El test (main-quiz-content) ya existe, solo debe estar oculto si no hay usuario -->
    <div class="max-w-4xl mx-auto hidden" id="main-quiz-content">
        <header class="mb-8">
             <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <img src="https://i.postimg.cc/T3YGBCsY/Screenshot-1.png" alt="Microsoft Certified Associate" class="w-16 h-16 rounded-lg shadow-md">
                    <div>
                        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">Test Certificación AZ-104</h1>
                        <p id="question-category" class="text-sm text-gray-500 dark:text-gray-400 font-medium"></p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-2 rounded-full shadow-md w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-adjust"></i>
                    </button>
                    <button id="view-btn" onclick="toggleViewModal()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                        <i class="fas fa-list-check"></i> Visualizar
                    </button>
                </div>
            </div>
             <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <p id="progress-text" class="mt-2 text-md text-gray-600 dark:text-gray-300 text-center">Pregunta 1 de 100</p>
        </header>

        <div id="quiz-container">
            <!-- Las preguntas se cargarán aquí -->
        </div>

        <div id="navigation-controls" class="mt-6 flex justify-between items-center">
             <button id="prev-btn" onclick="prevQuestion()" class="nav-btn bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
                Anterior
            </button>
            <div class="flex items-center gap-4">
                 <button id="check-btn" onclick="checkAnswer()" class="nav-btn bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 disabled:bg-green-400">
                    Comprobar
                </button>
                <button id="next-btn" onclick="nextQuestion()" class="nav-btn bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-400">
                    Siguiente
                </button>
            </div>
        </div>

        <div id="result-container" class="hidden text-center mt-8 p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4">¡Test Terminado!</h2>
            <div id="result-details" class="text-lg mb-4"></div>
            <p id="score-percentage" class="text-4xl font-bold mb-2"></p>
            <p id="result-message" class="text-2xl font-semibold mb-6"></p>
            
            <!-- Contenedor para los resultados por categoría -->
            <div id="category-results-container" class="mt-8 text-left">
                <h3 class="text-xl font-bold mb-4 text-center">Desglose por Área de Aptitud</h3>
                <div id="category-results" class="space-y-4">
                    <!-- Los resultados por categoría se insertarán aquí -->
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                <button onclick="restartGame()" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
                    <i class="fas fa-redo"></i> Volver a Jugar
                </button>
                 <button onclick="startReview()" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
                    <i class="fas fa-search"></i> Revisar Test
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Visualización (Ver Resumen) -->
    <div id="view-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40" role="dialog" aria-modal="true" aria-labelledby="view-modal-title">
        <div class="modal-container bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto p-6 transform scale-95">
             <div class="flex justify-between items-center border-b pb-3 mb-3 dark:border-gray-600">
                 <h3 id="view-modal-title" class="text-xl font-semibold">Resumen del Test</h3>
                 <button onclick="toggleViewModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-2xl" aria-label="Cerrar resumen">&times;</button>
            </div>
            <div id="summary-lists" class="space-y-4">
                <!-- Las listas se generan dinámicamente -->
            </div>
            <div class="mt-6 pt-4 border-t dark:border-gray-600 text-center">
                 <button onclick="confirmFinishTest()" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Finalizar test">
                    Finalizar Test
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmación -->
    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
        <div class="modal-container bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 transform scale-95 text-center">
            <h3 id="confirm-title" class="text-lg font-semibold mb-4">¿Finalizar Test?</h3>
            <p id="confirm-message" class="mb-6 text-gray-600 dark:text-gray-300">Hay preguntas sin contestar. ¿Estás seguro?</p>
            <div class="flex justify-center gap-4">
                <button onclick="handleFinishConfirmation(false)" class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600" aria-label="Cancelar finalización">Cancelar</button>
                <button onclick="handleFinishConfirmation(true)" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700" aria-label="Confirmar finalización">Finalizar</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        const C = {
            ID_GOV: "Administración de identidades y gobernanza en Azure",
            STORAGE: "Implementación y administración del almacenamiento",
            COMPUTE: "Implementación y administración de recursos de cómputo de Azure",
            NETWORK: "Implementación y administración de redes virtuales",
            MONITOR: "Supervisión y mantenimiento de recursos de Azure"
        };

        const originalQuizData = [
            // Módulo 1: Identidades y Gobernanza (20 preguntas)
            { question: "1. Necesitas asegurarte de que los nuevos recursos de almacenamiento creados en un grupo de recursos específico no permitan el acceso público. ¿Qué herramienta de Azure deberías usar?", options: ["Azure Advisor", "Azure Policy", "Control de Acceso Basado en Roles (RBAC)", "Microsoft Defender for Cloud"], answer: "Azure Policy", comment: "Azure Policy se utiliza para crear, asignar y administrar directivas que aplican reglas y efectos sobre los recursos, garantizando que cumplan con los estándares corporativos.", category: C.ID_GOV, subtopic: "Implementación y administración de Azure Policy" },
            { question: "2. Un nuevo empleado necesita permisos para crear y administrar máquinas virtuales en un grupo de recursos específico, pero no debe tener permisos sobre otros tipos de recursos. ¿Qué rol RBAC deberías asignarle?", options: ["Propietario (Owner)", "Colaborador (Contributor)", "Colaborador de la máquina virtual (Virtual Machine Contributor)", "Lector (Reader)"], answer: "Colaborador de la máquina virtual (Virtual Machine Contributor)", comment: "El rol de 'Colaborador de la máquina virtual' proporciona los permisos necesarios para administrar VMs, pero no otros recursos, siguiendo el principio de privilegios mínimos.", category: C.ID_GOV, subtopic: "Administración de roles de Azure integrados" },
            { question: "3. ¿Cuál es el propósito principal de los Grupos de Administración de Azure (Management Groups)?", options: ["Agrupar máquinas virtuales para balanceo de carga.", "Aplicar políticas y control de acceso a múltiples suscripciones.", "Organizar recursos dentro de una suscripción.", "Sincronizar identidades con un Active Directory local."], answer: "Aplicar políticas y control de acceso a múltiples suscripciones.", comment: "Los grupos de administración son un nivel de ámbito por encima de las suscripciones, diseñados para gestionar de forma eficiente el acceso y las directivas en un conjunto de suscripciones.", category: C.ID_GOV, subtopic: "Configuración de grupos de administración" },
            { question: "4. Quieres proteger una máquina virtual crítica para que no sea eliminada accidentalmente. ¿Qué acción debes realizar?", options: ["Asignar una directiva de Azure Deny.", "Aplicar un bloqueo de recursos (Resource Lock) de tipo `CanNotDelete`.", "Quitar el rol de Colaborador a todos los usuarios.", "Habilitar la autenticación multifactor (MFA) para la suscripción."], answer: "Aplicar un bloqueo de recursos (Resource Lock) de tipo `CanNotDelete`.", comment: "Los bloqueos de recursos se utilizan para evitar que los usuarios autorizados eliminen o modifiquen accidentalmente recursos críticos.", category: C.ID_GOV, subtopic: "Configuración de bloqueos de recursos" },
            { question: "5. ¿Qué servicio de Azure AD permite a los usuarios restablecer sus propias contraseñas sin la intervención del soporte técnico?", options: ["Azure AD Identity Protection", "Acceso Condicional (Conditional Access)", "Restablecimiento de contraseña de autoservicio (SSPR)", "Azure AD Privileged Identity Management (PIM)"], answer: "Restablecimiento de contraseña de autoservicio (SSPR)", comment: "SSPR es una característica de Azure AD que permite a los usuarios cambiar o restablecer su contraseña, reduciendo la carga de trabajo del departamento de TI.", category: C.ID_GOV, subtopic: "Configuración del autoservicio de restablecimiento de contraseña (SSPR)" },
            { question: "6. ¿Qué es Azure AD Connect?", options: ["Un servicio para conectar redes virtuales entre sí.", "Una herramienta para sincronizar identidades de un Active Directory local con Azure AD.", "Un conector para servicios de almacenamiento de terceros.", "Una API para gestionar recursos de Azure mediante programación."], answer: "Una herramienta para sincronizar identidades de un Active Directory local con Azure AD.", comment: "Azure AD Connect es la herramienta de Microsoft diseñada para cumplir los objetivos de identidad híbrida, incluida la sincronización de hash de contraseñas y la federación.", category: C.ID_GOV },
            { question: "7. Necesitas otorgar a un consultor externo acceso temporal a un rol privilegiado como 'Administrador Global'. ¿Qué servicio de Azure AD es el más adecuado?", options: ["Azure AD B2C", "Azure AD Domain Services", "Azure AD Privileged Identity Management (PIM)", "Asignaciones de roles RBAC estándar."], answer: "Azure AD Privileged Identity Management (PIM)", comment: "PIM es un servicio que permite la administración, el control y la supervisión del acceso just-in-time (JIT) a recursos importantes en Azure AD.", category: C.ID_GOV },
            { question: "8. ¿Cuál es el ámbito de una asignación de Azure Policy?", options: ["Solo a nivel de Grupo de Recursos.", "Solo a nivel de Suscripción.", "A nivel de Grupo de Administración, Suscripción o Grupo de Recursos.", "Solo a nivel de Tenant de Azure AD."], answer: "A nivel de Grupo de Administración, Suscripción o Grupo de Recursos.", comment: "Las directivas se pueden asignar en diferentes niveles de la jerarquía de Azure para proporcionar una gobernanza granular o amplia.", category: C.ID_GOV },
            { question: "9. ¿Para qué se utiliza el etiquetado (tagging) de recursos en Azure?", options: ["Para aplicar reglas de seguridad a los recursos.", "Para organizar los recursos con fines de facturación y administración.", "Para cifrar los datos de los recursos.", "Para conectar recursos a una red virtual."], answer: "Para organizar los recursos con fines de facturación y administración.", comment: "Las etiquetas son pares de metadatos (clave-valor) que permiten organizar lógicamente los recursos, lo que facilita la gestión de costos y la administración.", category: C.ID_GOV },
            { question: "10. ¿Qué es una directiva de Acceso Condicional (Conditional Access) en Azure AD?", options: ["Una regla que bloquea el acceso a todos los recursos de Azure.", "Una herramienta para analizar los costos de los recursos.", "Una regla 'if-then' que evalúa señales (usuario, ubicación, etc.) para permitir, bloquear o requerir acciones adicionales (MFA) para acceder a los recursos.", "Una directiva que define los tamaños de VM permitidos."], answer: "Una regla 'if-then' que evalúa señales (usuario, ubicación, etc.) para permitir, bloquear o requerir acciones adicionales (MFA) para acceder a los recursos.", comment: "El Acceso Condicional es el corazón del plano de control de identidades de Microsoft, permitiendo una seguridad granular y automatizada.", category: C.ID_GOV },
            { question: "51. ¿Qué es una plantilla de Azure Resource Manager (ARM)?", options: ["Un script de PowerShell para implementar recursos.", "Un archivo JSON que define uno o más recursos para implementar.", "Una imagen de máquina virtual preconfigurada.", "Un panel de control de Azure predefinido."], answer: "Un archivo JSON que define uno o más recursos para implementar.", comment: "Las plantillas ARM permiten la implementación declarativa y repetible de la infraestructura de Azure, una práctica clave de la Infraestructura como Código (IaC).", category: C.ID_GOV },
            { question: "52. Estás configurando una VPN de sitio a sitio. ¿Qué recurso representa tu dispositivo VPN local en Azure?", options: ["Puerta de enlace de red virtual (Virtual Network Gateway).", "Conexión (Connection).", "Puerta de enlace de red local (Local Network Gateway).", "Circuito ExpressRoute."], answer: "Puerta de enlace de red local (Local Network Gateway).", comment: "La puerta de enlace de red local es un objeto en Azure que representa tu dispositivo VPN físico en tu red local.", category: C.NETWORK },
            { question: "56. ¿Qué es una Zona DNS Privada (Private DNS Zone) en Azure?", options: ["Una zona DNS que solo se puede administrar desde una red local.", "Un servicio que proporciona resolución de nombres dentro de una red virtual y entre redes virtuales.", "Una zona DNS que está protegida por Azure Firewall.", "Un alias para una zona DNS pública."], answer: "Un servicio que proporciona resolución de nombres dentro de una red virtual y entre redes virtuales.", comment: "Las zonas DNS privadas permiten usar tus propios nombres de dominio personalizados en lugar de los nombres proporcionados por Azure.", category: C.NETWORK },
            { question: "57. ¿Qué tipo de identidad administrada (Managed Identity) está vinculada al ciclo de vida de un recurso de Azure específico, como una VM?", options: ["Asignada por el sistema (System-assigned).", "Asignada por el usuario (User-assigned).", "Asignada por el servicio (Service-assigned).", "Asignada por el grupo (Group-assigned)."], answer: "Asignada por el sistema (System-assigned).", comment: "Una identidad administrada asignada por el sistema se crea y se elimina junto con el recurso de Azure al que está asociada.", category: C.ID_GOV },
            { question: "67. ¿Qué rol de Azure AD se necesita como mínimo para crear y administrar casos de soporte técnico de Azure?", options: ["Administrador Global", "Propietario de la suscripción", "Administrador de Soporte Técnico", "Cualquier usuario autenticado puede crear un ticket de soporte."], answer: "Administrador de Soporte Técnico", comment: "El rol de Administrador de Soporte Técnico (o un rol con el permiso `Microsoft.Support/supportTickets/write`) es necesario para abrir y gestionar solicitudes de soporte.", category: C.ID_GOV },
            { question: "72. ¿Qué tipo de cuenta de Azure AD se utiliza para aplicaciones que necesitan acceder a recursos de Azure sin la intervención de un usuario?", options: ["Cuenta de usuario", "Cuenta de invitado", "Entidad de servicio (Service Principal)", "Grupo"], answer: "Entidad de servicio (Service Principal)", comment: "Una entidad de servicio es una identidad que se crea para que la usen aplicaciones, servicios hospedados y herramientas automatizadas para acceder a los recursos de Azure.", category: C.ID_GOV },
            { question: "80. ¿Cuál es el propósito de Azure Key Vault?", options: ["Almacenar copias de seguridad de máquinas virtuales.", "Almacenar y administrar de forma segura secretos, claves y certificados.", "Almacenar archivos de registro de diagnóstico.", "Almacenar imágenes de Docker."], answer: "Almacenar y administrar de forma segura secretos, claves y certificados.", comment: "Key Vault ayuda a controlar los secretos de las aplicaciones al mantenerlos en una ubicación centralizada y proporcionar un acceso seguro.", category: C.ID_GOV },
            { question: "84. ¿Qué es el 'acceso entre tenants' en Azure AD B2B?", options: ["La capacidad de un usuario de acceder a recursos en su propio tenant.", "La configuración que controla cómo colaboran los usuarios de otros tenants contigo y cómo tus usuarios colaboran con otros tenants.", "Una conexión VPN entre dos tenants.", "La sincronización de todos los usuarios entre dos tenants."], answer: "La configuración que controla cómo colaboran los usuarios de otros tenants contigo y cómo tus usuarios colaboran con otros tenants.", comment: "Permite una colaboración segura y granular con organizaciones externas al definir qué tenants están permitidos y qué nivel de acceso tienen.", category: C.ID_GOV },
            { question: "89. ¿Qué es una 'iniciativa' en Azure Policy?", options: ["Una única regla de directiva.", "Una colección de definiciones de directivas que se agrupan para lograr un objetivo general.", "Una exención a una directiva.", "El registro de cumplimiento de una directiva."], answer: "Una colección de definiciones de directivas que se agrupan para lograr un objetivo general.", comment: "Las iniciativas simplifican la gestión de directivas al permitirte asignar un grupo de directivas relacionadas como una sola entidad.", category: C.ID_GOV, subtopic: "Implementación y administración de iniciativas en Azure Policy" },
            { question: "96. ¿Qué es una 'zona de aterrizaje' (Landing Zone) de Azure?", options: ["Una región de Azure específica para nuevos clientes.", "Un entorno de Azure preparado para alojar cargas de trabajo, siguiendo las mejores prácticas de gobernanza, seguridad y operaciones.", "Una red virtual preconfigurada.", "Una suscripción de Azure con recursos de ejemplo."], answer: "Un entorno de Azure preparado para alojar cargas de trabajo, siguiendo las mejores prácticas de gobernanza, seguridad y operaciones.", comment: "Las zonas de aterrizaje son el resultado de una arquitectura de escala empresarial y proporcionan una base sólida para construir y migrar aplicaciones a Azure.", category: C.ID_GOV },

            // Módulo 2: Almacenamiento (20 preguntas)
            { question: "11. ¿Qué tipo de cuenta de almacenamiento de Azure ofrece el nivel de rendimiento más alto para cargas de trabajo de baja latencia?", options: ["General-purpose v2", "General-purpose v1", "BlockBlobStorage", "Premium Block Blobs"], answer: "Premium Block Blobs", comment: "Las cuentas de almacenamiento Premium utilizan SSD y están optimizadas para cargas de trabajo que requieren tasas de transacción muy altas y baja latencia.", category: C.STORAGE },
            { question: "12. Necesitas almacenar 2 TB de archivos que serán compartidos entre varias VMs de Azure usando el protocolo SMB. ¿Qué servicio de almacenamiento deberías usar?", options: ["Azure Blob Storage", "Azure Files", "Azure Disk Storage", "Azure Table Storage"], answer: "Azure Files", comment: "Azure Files ofrece recursos compartidos de archivos totalmente administrados en la nube a los que se puede acceder a través de los protocolos estándar SMB y NFS.", category: C.STORAGE },
            { question: "13. ¿Qué es la Replicación con redundancia de zona (ZRS)?", options: ["Replica los datos en tres centros de datos dentro de una región.", "Replica los datos en tres zonas de disponibilidad dentro de una región.", "Replica los datos a una región secundaria.", "Crea 3 copias de los datos en un único centro de datos."], answer: "Replica los datos en tres zonas de disponibilidad dentro de una región.", comment: "ZRS ofrece alta disponibilidad al replicar los datos en tres zonas de disponibilidad distintas dentro de la misma región.", category: C.STORAGE },
            { question: "14. ¿Para qué se utiliza una Firma de Acceso Compartido (SAS)?", options: ["Para cifrar los datos en una cuenta de almacenamiento.", "Para proporcionar acceso delegado y granular a los recursos de una cuenta de almacenamiento.", "Para conectar una cuenta de almacenamiento a una red virtual.", "Para sincronizar datos entre dos cuentas de almacenamiento."], answer: "Para proporcionar acceso delegado y granular a los recursos de una cuenta de almacenamiento.", comment: "Una SAS proporciona a los clientes un acceso seguro y delegado a los recursos de la cuenta de almacenamiento, especificando permisos y tiempo de validez.", category: C.STORAGE },
            { question: "15. Estás configurando Azure File Sync. ¿Qué componente se instala en tu servidor de archivos de Windows Server local?", options: ["El agente de Azure Monitor.", "El agente de Azure Arc.", "El agente de Azure File Sync.", "El cliente de Azure AD Connect."], answer: "El agente de Azure File Sync.", comment: "El agente de Azure File Sync es un paquete descargable que se instala en un Windows Server para habilitar la sincronización con un recurso compartido de archivos de Azure.", category: C.STORAGE },
            { question: "16. ¿Qué nivel de acceso de Blob Storage es el más económico para datos a los que se accede con poca frecuencia y con horas de latencia de recuperación?", options: ["Premium", "Frecuente (Hot)", "Esporádico (Cool)", "Archivo (Archive)"], answer: "Archivo (Archive)", comment: "El nivel de Archivo está optimizado para almacenar datos que rara vez se acceden, ofreciendo el costo de almacenamiento más bajo.", category: C.STORAGE },
            { question: "17. Necesitas copiar una gran cantidad de datos desde un centro de datos local a Azure Blob Storage rápidamente, pero tu conexión a Internet es lenta. ¿Qué servicio deberías considerar?", options: ["AzCopy", "Azure Storage Explorer", "Azure Data Box", "Azure File Sync"], answer: "Azure Data Box", comment: "Azure Data Box es un dispositivo físico que Microsoft te envía para cargar datos localmente y enviarlo de vuelta, evitando las limitaciones del ancho de banda.", category: C.STORAGE },
            { question: "18. ¿Qué característica de Azure Storage permite montar un contenedor de blobs como un sistema de archivos en una máquina Linux?", options: ["BlobFuse", "Azure File Sync", "SMB 3.0", "NFS v4.1"], answer: "BlobFuse", comment: "BlobFuse es un controlador de sistema de archivos virtual para Azure Blob Storage que permite acceder a los datos de blobs a través del sistema de archivos de Linux.", category: C.STORAGE },
            { question: "19. ¿Cómo puedes restringir el acceso a una cuenta de almacenamiento para que solo sea accesible desde una red virtual específica?", options: ["Usando una Firma de Acceso Compartido (SAS).", "Configurando un Punto de Conexión de Servicio o un Punto de Conexión Privado.", "Asignando un rol RBAC de 'Lector de Red'.", "Creando una regla de entrada en un Grupo de Seguridad de Red (NSG)."], answer: "Configurando un Punto de Conexión de Servicio o un Punto de Conexión Privado.", comment: "Los puntos de conexión de servicio y privados son los mecanismos para asegurar el tráfico a los servicios de Azure directamente desde una red virtual.", category: C.STORAGE },
            { question: "20. ¿Qué utilidad de línea de comandos está optimizada para copiar datos hacia y desde Azure Blob y File Storage?", options: ["bcp", "robocopy", "AzCopy", "scp"], answer: "AzCopy", comment: "AzCopy es una utilidad de línea de comandos diseñada para transferencias de datos de alto rendimiento hacia y desde Azure Storage.", category: C.STORAGE, subtopic: "Administración de datos mediante AzCopy" },
            { question: "61. ¿Qué política de ciclo de vida de almacenamiento podrías aplicar para mover automáticamente blobs no modificados en 30 días del nivel Frecuente al Esporádico?", options: ["Una regla que se activa por la fecha de creación.", "Una regla con la acción `tierToCool` y una condición `daysAfterModificationGreaterThan` en 30.", "Una regla que elimina los blobs después de 30 días.", "Una regla de Azure Backup."], answer: "Una regla con la acción `tierToCool` y una condición `daysAfterModificationGreaterThan` en 30.", comment: "Las políticas de administración del ciclo de vida te permiten automatizar la transición de datos a niveles de almacenamiento más económicos.", category: C.STORAGE },
            { question: "68. ¿Cuál es la principal ventaja de usar discos administrados (Managed Disks) en lugar de discos no administrados?", options: ["Son más baratos.", "Azure gestiona las cuentas de almacenamiento, eliminando la complejidad y proporcionando mejor escalabilidad.", "Tienen un rendimiento más rápido por defecto.", "Se pueden adjuntar a más VMs simultáneamente."], answer: "Azure gestiona las cuentas de almacenamiento, eliminando la complejidad y proporcionando mejor escalabilidad.", comment: "Los discos administrados simplifican enormemente la gestión de discos al abstraer la complejidad de las cuentas de almacenamiento.", category: C.COMPUTE, subtopic: "Administración de discos de máquinas virtuales" },
            { question: "70. ¿Qué es una instantánea de disco (Disk Snapshot)?", options: ["Una copia de seguridad completa de una VM.", "Una copia de solo lectura de un VHD en un momento dado, que se puede usar para crear nuevas VMs o para restaurar un disco.", "Una imagen de VM.", "Un registro de los cambios en un disco."], answer: "Una copia de solo lectura de un VHD en un momento dado, que se puede usar para crear nuevas VMs o para restaurar un disco.", comment: "Las instantáneas son una forma rápida y económica de hacer una copia de seguridad de un disco antes de realizar cambios importantes.", category: C.COMPUTE },
            { question: "74. ¿Qué es el 'acceso anónimo' a un contenedor de Azure Blob Storage?", options: ["Acceso que requiere una clave de cuenta de almacenamiento.", "Acceso que requiere una firma de acceso compartido (SAS).", "Acceso público y no autenticado a los blobs dentro de un contenedor.", "Acceso que requiere autenticación de Azure AD."], answer: "Acceso público y no autenticado a los blobs dentro de un contenedor.", comment: "Puedes configurar un contenedor para permitir el acceso público, lo que es útil para servir activos como imágenes o documentos en un sitio web.", category: C.STORAGE },
            { question: "77. ¿Qué es la replicación geográfica con acceso de lectura (RA-GRS) para Azure Storage?", options: ["Replica los datos en tres zonas de disponibilidad.", "Replica los datos a una región secundaria y proporciona acceso de solo lectura a los datos en la ubicación secundaria.", "Replica los datos en múltiples regiones y permite el acceso de lectura/escritura en todas ellas.", "Es una copia de seguridad de la cuenta de almacenamiento."], answer: "Replica los datos a una región secundaria y proporciona acceso de solo lectura a los datos en la ubicación secundaria.", comment: "RA-GRS proporciona alta disponibilidad para la lectura al permitir que las aplicaciones lean desde la réplica secundaria.", category: C.STORAGE },
            { question: "79. ¿Qué es el 'Bursting' de disco en Azure?", options: ["Una característica que permite que un disco exceda su límite de rendimiento (IOPS y MB/s) durante períodos limitados.", "La capacidad de aumentar el tamaño de un disco mientras está en uso.", "Un tipo de cifrado de disco.", "La replicación de un disco a otra región."], answer: "Una característica que permite que un disco exceda su límite de rendimiento (IOPS y MB/s) durante períodos limitados.", comment: "El bursting basado en créditos permite que los discos manejen picos de tráfico inesperados de manera más efectiva.", category: C.COMPUTE },
            { question: "85. ¿Qué es el 'Cifrado de servicio de almacenamiento de Azure' (SSE)?", options: ["Cifrado de datos en tránsito.", "Cifrado de datos en reposo, donde Azure cifra automáticamente los datos antes de persistirlos.", "Cifrado del lado del cliente.", "Cifrado de la conexión de red a la cuenta de almacenamiento."], answer: "Cifrado de datos en reposo, donde Azure cifra automáticamente los datos antes de persistirlos.", comment: "SSE está habilitado por defecto en todas las cuentas de almacenamiento y no se puede deshabilitar, garantizando que los datos en reposo estén siempre cifrados.", category: C.STORAGE },
            { question: "91. ¿Qué es el 'Azure Disk Encryption' (ADE)?", options: ["Cifrado de datos en tránsito.", "Cifrado de datos en reposo a nivel de cuenta de almacenamiento (SSE).", "Una capacidad para cifrar los discos de SO y de datos de VMs IaaS usando BitLocker (Windows) y DM-Crypt (Linux).", "Cifrado de la conexión RDP a una VM."], answer: "Una capacidad para cifrar los discos de SO y de datos de VMs IaaS usando BitLocker (Windows) y DM-Crypt (Linux).", comment: "ADE se integra con Azure Key Vault para ayudarte a controlar y administrar las claves de cifrado de disco.", category: C.COMPUTE },
            { question: "97. ¿Qué es la 'consistencia final' en el contexto de Azure Storage con replicación geográfica (GRS)?", options: ["Los datos se escriben en la región primaria y secundaria simultáneamente.", "Los datos se escriben en la primaria y luego se replican de forma asíncrona a la secundaria, pudiendo haber un breve retraso.", "Los datos son consistentes en todo momento en ambas regiones.", "La consistencia de los datos no está garantizada."], answer: "Los datos se escriben en la primaria y luego se replican de forma asíncrona a la secundaria, pudiendo haber un breve retraso.", comment: "Debido a la naturaleza asíncrona de la replicación, GRS y RA-GRS operan con un modelo de consistencia final para los datos en la región secundaria.", category: C.STORAGE },
            { question: "66. ¿Qué es el emparejamiento de redes virtuales global (Global VNet Peering)?", options: ["Conectar redes virtuales en la misma región.", "Conectar redes virtuales en diferentes regiones de Azure.", "Conectar una red virtual a una red local.", "Conectar una red virtual a Internet."], answer: "Conectar redes virtuales en diferentes regiones de Azure.", comment: "El emparejamiento global permite que los recursos de una VNet se comuniquen con recursos de otra VNet en una región de Azure diferente de forma privada.", category: C.NETWORK },

            // Módulo 3: Cómputo (20 preguntas)
            { question: "21. Necesitas implementar un conjunto de máquinas virtuales idénticas que se escalen automáticamente según la demanda. ¿Qué recurso de cómputo de Azure deberías usar?", options: ["Conjuntos de disponibilidad (Availability Sets)", "Conjuntos de escalado de máquinas virtuales (Virtual Machine Scale Sets)", "Azure DevTest Labs", "Máquinas virtuales individuales"], answer: "Conjuntos de escalado de máquinas virtuales (Virtual Machine Scale Sets)", comment: "Los conjuntos de escalado permiten crear y administrar un grupo de máquinas virtuales con equilibrio de carga y escalado automático.", category: C.COMPUTE },
            { question: "22. ¿Cuál es el propósito de un Conjunto de Disponibilidad (Availability Set)?", options: ["Escalar automáticamente el número de VMs.", "Proteger las aplicaciones contra fallos de hardware distribuyendo VMs en diferentes dominios de error y actualización.", "Distribuir VMs entre diferentes regiones de Azure.", "Agrupar VMs para una gestión de costos más sencilla."], answer: "Proteger las aplicaciones contra fallos de hardware distribuyendo VMs en diferentes dominios de error y actualización.", comment: "Un conjunto de disponibilidad garantiza que las VMs se coloquen en diferentes racks (dominios de error) y se actualicen en momentos diferentes (dominios de actualización).", category: C.COMPUTE },
            { question: "23. ¿Qué son las Zonas de Disponibilidad (Availability Zones)?", options: ["Un conjunto de centros de datos dentro de una región, cada uno con energía, refrigeración y redes independientes.", "Un grupo lógico de máquinas virtuales para escalado.", "Un tipo de cuenta de almacenamiento con alta disponibilidad.", "Un conjunto de reglas de firewall para proteger las VMs."], answer: "Un conjunto de centros de datos dentro de una región, cada uno con energía, refrigeración y redes independientes.", comment: "Las Zonas de Disponibilidad ofrecen un SLA del 99,99% al proteger las aplicaciones y los datos de los fallos de todo un centro de datos.", category: C.COMPUTE },
            { question: "24. Necesitas ejecutar un script de configuración en una nueva VM de Windows en el momento de su creación. ¿Qué deberías usar?", options: ["Una tarea programada de Windows.", "Una extensión de script personalizado (Custom Script Extension).", "Un script de inicio de sesión de directiva de grupo.", "Azure Automation."], answer: "Una extensión de script personalizado (Custom Script Extension).", comment: "La extensión de script personalizado descarga y ejecuta scripts en VMs de Azure. Es útil para la configuración posterior a la implementación.", category: C.COMPUTE },
            { question: "25. ¿Qué es una imagen de máquina virtual en Azure?", options: ["Una instantánea de un disco de una VM.", "Una plantilla que se utiliza para crear una máquina virtual, que incluye un SO y software opcional.", "Un archivo de copia de seguridad de una VM.", "Un contenedor Docker."], answer: "Una plantilla que se utiliza para crear una máquina virtual, que incluye un SO y software opcional.", comment: "Las imágenes se utilizan para estandarizar y acelerar la implementación de VMs. Se pueden usar imágenes del Marketplace o crear imágenes personalizadas.", category: C.COMPUTE, subtopic: "Creación y uso de imágenes de máquina virtual" },
            { question: "26. Quieres mover un disco de una VM de HDD estándar a SSD prémium. ¿Qué acción debes realizar?", options: ["No es posible cambiar el tipo de disco una vez creado.", "Detener (desasignar) la VM, cambiar el tipo de disco y luego iniciar la VM.", "Crear una nueva VM con un disco SSD prémium y migrar los datos.", "Ejecutar un comando de PowerShell mientras la VM está en funcionamiento."], answer: "Detener (desasignar) la VM, cambiar el tipo de disco y luego iniciar la VM.", comment: "Para cambiar el tipo de SKU de un disco administrado, la máquina virtual a la que está conectado el disco debe estar desasignada.", category: C.COMPUTE },
            { question: "27. ¿Cuál de los siguientes servicios de Azure es una plataforma de contenedores como servicio (CaaS) sin servidor?", options: ["Azure Kubernetes Service (AKS)", "Azure Container Instances (ACI)", "Azure Virtual Machines", "Azure App Service"], answer: "Azure Container Instances (ACI)", comment: "ACI es la forma más rápida y sencilla de ejecutar un contenedor en Azure, sin tener que administrar ninguna máquina virtual.", category: C.COMPUTE },
            { question: "28. Estás implementando una aplicación web en Azure App Service. Necesitas un entorno para pruebas que sea una réplica exacta del de producción. ¿Qué característica deberías usar?", options: ["Copias de seguridad (Backups)", "Ranuras de implementación (Deployment Slots)", "WebJobs", "Escalado automático (Autoscaling)"], answer: "Ranuras de implementación (Deployment Slots)", comment: "Las ranuras de implementación son entornos activos que permiten probar una nueva versión y luego intercambiarla con producción sin tiempo de inactividad.", category: C.COMPUTE },
            { question: "29. ¿Qué es Azure Kubernetes Service (AKS)?", options: ["Un servicio para ejecutar contenedores individuales.", "Un servicio de orquestación de contenedores totalmente administrado basado en Kubernetes.", "Un servicio de compilación e implementación de CI/CD.", "Un registro privado para imágenes de Docker."], answer: "Un servicio de orquestación de contenedores totalmente administrado basado en Kubernetes.", comment: "AKS simplifica la implementación y administración de Kubernetes al descargar la sobrecarga operativa a Azure.", category: C.COMPUTE },
            { question: "30. ¿Cómo se puede conectar de forma segura a una máquina virtual de Azure que no tiene una dirección IP pública?", options: ["Usando RDP a través de la dirección IP privada.", "Usando Azure Bastion.", "Usando el portal de Azure.", "No es posible conectarse a una VM sin IP pública."], answer: "Usando Azure Bastion.", comment: "Azure Bastion es un servicio PaaS que proporciona una conexión segura RDP/SSH a tus VMs directamente desde el portal de Azure sin necesidad de una IP pública en la VM.", category: C.COMPUTE },
            { question: "54. Necesitas asegurarte de que una aplicación web en App Service siempre tenga al menos 2 instancias en ejecución. ¿Qué configuración debes ajustar?", options: ["La configuración de escalado automático (Autoscale).", "La configuración de escalado manual (Scale out).", "La configuración de escalado vertical (Scale up).", "La configuración de la aplicación."], answer: "La configuración de escalado manual (Scale out).", comment: "El escalado manual (o 'Recuento de instancias') te permite establecer un número fijo de instancias que se ejecutarán constantemente.", category: C.COMPUTE },
            { question: "58. Necesitas migrar un gran número de máquinas virtuales VMware locales a Azure. ¿Qué servicio de Azure está diseñado para facilitar esta tarea?", options: ["Azure Backup", "Azure Migrate", "Azure Data Box", "Azure Automation"], answer: "Azure Migrate", comment: "Azure Migrate es el centro de servicios centralizado para descubrir, evaluar y migrar servidores, aplicaciones y datos locales a la nube de Azure.", category: C.COMPUTE },
            { question: "59. ¿Cuál es el número máximo de dominios de actualización (Update Domains) que puedes configurar en un Conjunto de Disponibilidad?", options: ["5", "10", "20", "3"], answer: "20", comment: "Puedes configurar hasta 20 dominios de actualización en un conjunto de disponibilidad. Esto define grupos de máquinas virtuales que se pueden reiniciar al mismo tiempo.", category: C.COMPUTE },
            { question: "60. ¿Qué SKU de Azure Bastion se necesita para usar características avanzadas como la carga/descarga de archivos nativa?", options: ["SKU Básico (Basic)", "SKU Estándar (Standard)", "SKU Premium", "SKU Avanzado (Advanced)"], answer: "SKU Estándar (Standard)", comment: "El SKU Estándar de Azure Bastion introduce características adicionales sobre el Básico, incluida la capacidad de ajustar el número de instancias.", category: C.NETWORK },
            { question: "64. ¿Cuál es el propósito de la extensión de VM 'AzurePerformanceDiagnostics'?", options: ["Para instalar software antivirus en la VM.", "Para recopilar registros de diagnóstico que ayudan a solucionar problemas de rendimiento de las VMs de Windows.", "Para realizar copias de seguridad de la VM.", "Para configurar las reglas de red de la VM."], answer: "Para recopilar registros de diagnóstico que ayudan a solucionar problemas de rendimiento de las VMs de Windows.", comment: "Esta extensión ejecuta herramientas de diagnóstico para recopilar información y puede proporcionar un informe para resolver problemas de rendimiento.", category: C.COMPUTE },
            { question: "75. ¿Qué servicio de Azure deberías usar para ejecutar un trabajo por lotes que requiere una gran cantidad de potencia de cómputo?", options: ["Azure App Service", "Azure Functions", "Azure Batch", "Azure Virtual Machines"], answer: "Azure Batch", comment: "Azure Batch está diseñado para ejecutar aplicaciones de computación de alto rendimiento (HPC) y a gran escala en paralelo de manera eficiente.", category: C.COMPUTE, subtopic: "Ejecución de trabajos por lotes con Azure Batch" },
            { question: "76. ¿Qué es un WebJob de Azure?", options: ["Una característica de App Service que permite ejecutar un programa o script en segundo plano.", "Un tipo de máquina virtual.", "Un servicio de CI/CD.", "Una regla de alerta."], answer: "Una característica de App Service que permite ejecutar un programa o script en segundo plano.", comment: "Los WebJobs son útiles para tareas en segundo plano, como el procesamiento de imágenes, el procesamiento de colas, etc.", category: C.COMPUTE },
            { question: "83. ¿Qué es un 'grupo de selección de ubicación de proximidad' (Proximity Placement Group)?", options: ["Un grupo lógico para asegurarse de que los recursos de cómputo de Azure estén físicamente ubicados lo más cerca posible.", "Un grupo de recursos que se encuentran en la misma región.", "Un grupo de seguridad de aplicaciones.", "Un grupo de VMs que comparten la misma subred."], answer: "Un grupo lógico para asegurarse de que los recursos de cómputo de Azure estén físicamente ubicados lo más cerca posible.", comment: "Esto es crucial para cargas de trabajo que requieren baja latencia entre máquinas virtuales, como las aplicaciones de HPC o SAP.", category: C.COMPUTE },
            { question: "88. ¿Cuál es el propósito de la extensión de VM 'AADLoginForWindows'?", options: ["Para unir la VM a un dominio de Active Directory local.", "Para permitir el inicio de sesión en una VM de Windows utilizando credenciales de Azure AD.", "Para instalar el navegador Edge en la VM.", "Para configurar el firewall de Windows."], answer: "Para permitir el inicio de sesión en una VM de Windows utilizando credenciales de Azure AD.", comment: "Permite una gestión de acceso centralizada y basada en la nube para tus VMs, habilitando MFA y acceso condicional.", category: C.COMPUTE },
            { question: "93. ¿Qué es un 'plan de App Service' (App Service Plan)?", options: ["Una aplicación web individual.", "Un conjunto de recursos de cómputo (región, número de VMs, etc.) en los que se ejecutan una o más aplicaciones web.", "Un plan de copia de seguridad para una aplicación web.", "Un conjunto de reglas de escalado para una aplicación web."], answer: "Un conjunto de recursos de cómputo (región, número de VMs, etc.) en los que se ejecutan una o más aplicaciones web.", comment: "El plan de App Service es la unidad de escala y costo. Puedes alojar múltiples aplicaciones en el mismo plan para optimizar costos.", category: C.COMPUTE },
            { question: "100. ¿Qué es un 'grupo de hosts dedicados' (Dedicated Host Group) de Azure?", options: ["Un grupo de máquinas virtuales que están dedicadas a un solo cliente.", "Un servicio que proporciona servidores físicos, dedicados a una sola suscripción, para alojar una o más VMs.", "Un tipo de plan de App Service.", "Un grupo de administradores dedicados a tu cuenta."], answer: "Un servicio que proporciona servidores físicos, dedicados a una sola suscripción, para alojar una o más VMs.", comment: "Los hosts dedicados proporcionan aislamiento a nivel de servidor físico, lo que puede ser necesario para cumplir con requisitos de cumplimiento normativo.", category: C.COMPUTE },

            // Módulo 4: Redes (20 preguntas)
            { question: "31. ¿Qué componente de red de Azure se utiliza para filtrar el tráfico hacia y desde los recursos de Azure en una red virtual?", options: ["Azure Load Balancer", "Azure Firewall", "Grupos de Seguridad de Red (NSG)", "Azure DNS"], answer: "Grupos de Seguridad de Red (NSG)", comment: "Un NSG contiene una lista de reglas de seguridad que permiten o deniegan el tráfico de red a los recursos. Se pueden asociar a subredes o a NICs.", category: C.NETWORK },
            { question: "32. Necesitas conectar dos redes virtuales en la misma región para que los recursos en ambas puedan comunicarse. ¿Qué deberías configurar?", options: ["Una puerta de enlace de VPN.", "Emparejamiento de redes virtuales (VNet Peering).", "Una conexión ExpressRoute.", "Un punto de conexión de servicio."], answer: "Emparejamiento de redes virtuales (VNet Peering).", comment: "El emparejamiento de VNet permite conectar redes virtuales de forma transparente. El tráfico entre las redes emparejadas utiliza la red troncal de Microsoft.", category: C.NETWORK },
            { question: "33. ¿Cuál es la diferencia principal entre un Azure Load Balancer Básico y uno Estándar?", options: ["El Básico solo funciona con VMs, mientras que el Estándar funciona con cualquier recurso.", "El Estándar está respaldado por un SLA y puede abarcar Zonas de Disponibilidad, mientras que el Básico no.", "El Básico es para tráfico interno y el Estándar para tráfico público.", "El Estándar incluye protección contra DDoS, mientras que el Básico no."], answer: "El Estándar está respaldado por un SLA y puede abarcar Zonas de Disponibilidad, mientras que el Básico no.", comment: "El Load Balancer Estándar es la oferta recomendada, ya que proporciona una mayor escala, seguridad y alta disponibilidad.", category: C.NETWORK, subtopic: "Diferencias y selección de SKU en Azure Load Balancer" },
            { question: "34. ¿Qué servicio de Azure proporciona un equilibrio de carga de capa 7 (HTTP/HTTPS) con enrutamiento basado en URL?", options: ["Azure Load Balancer", "Azure Traffic Manager", "Azure Application Gateway", "Azure Firewall"], answer: "Azure Application Gateway", comment: "Application Gateway es un equilibrador de carga de tráfico web que permite administrar el tráfico a las aplicaciones web. Funciona en la capa de aplicación (OSI capa 7).", category: C.NETWORK },
            { question: "35. ¿Cómo funciona Azure Traffic Manager?", options: ["Equilibrando la carga del tráfico de red en la capa 4.", "Usando DNS para dirigir a los clientes a los puntos de conexión en diferentes regiones según un método de enrutamiento.", "Filtrando el tráfico malicioso a las aplicaciones web.", "Proporcionando conectividad privada entre redes locales y Azure."], answer: "Usando DNS para dirigir a los clientes a los puntos de conexión en diferentes regiones según un método de enrutamiento.", comment: "Traffic Manager es un equilibrador de carga de tráfico basado en DNS. No ve el tráfico que pasa entre el cliente y el servicio.", category: C.NETWORK },
            { question: "36. Necesitas establecer una conexión privada y dedicada entre tu centro de datos local y Azure. ¿Qué servicio deberías usar?", options: ["VPN de sitio a sitio", "VPN de punto a sitio", "Azure ExpressRoute", "Emparejamiento de VNet"], answer: "Azure ExpressRoute", comment: "ExpressRoute permite extender las redes locales a la nube de Microsoft a través de una conexión privada, ofreciendo mayor fiabilidad y velocidades más rápidas.", category: C.NETWORK },
            { question: "37. ¿Qué es una tabla de rutas (Route Table) en Azure?", options: ["Una lista de reglas de NSG.", "Una tabla que contiene entradas que especifican cómo se deben enrutar los paquetes en una red virtual.", "Un registro de las consultas DNS.", "Una lista de las conexiones de emparejamiento de VNet."], answer: "Una tabla que contiene entradas que especifican cómo se deben enrutar los paquetes en una red virtual.", comment: "Puedes crear tablas de rutas para anular las rutas predeterminadas de Azure, por ejemplo, para forzar el tráfico a través de una NVA.", category: C.NETWORK },
            { question: "38. ¿Cuál es el propósito de Azure DNS?", options: ["Proporcionar un firewall para dominios.", "Un servicio de alojamiento para dominios DNS que proporciona resolución de nombres mediante la infraestructura de Azure.", "Registrar nuevos nombres de dominio.", "Equilibrar la carga del tráfico DNS."], answer: "Un servicio de alojamiento para dominios DNS que proporciona resolución de nombres mediante la infraestructura de Azure.", comment: "Puedes alojar tus zonas DNS (por ejemplo, `contoso.com`) en Azure y administrar los registros DNS para tus servicios.", category: C.NETWORK },
            { question: "39. Estás configurando un Application Gateway y necesitas protegerlo contra inyección de SQL. ¿Qué característica debes habilitar?", options: ["Reglas de enrutamiento básicas.", "Descarga de SSL.", "Firewall de aplicaciones web (WAF).", "Afinidad de sesión basada en cookies."], answer: "Firewall de aplicaciones web (WAF).", comment: "El WAF es una característica de Application Gateway que proporciona protección centralizada de las aplicaciones web frente a vulnerabilidades comunes.", category: C.NETWORK },
            { question: "40. ¿Qué es un Punto de Conexión Privado (Private Endpoint) de Azure?", options: ["Una dirección IP pública para un servicio de Azure.", "Una interfaz de red que te conecta de forma privada y segura a un servicio con tecnología de Azure Private Link.", "Un túnel VPN a un servicio específico.", "Un registro DNS para un servicio interno."], answer: "Una interfaz de red que te conecta de forma privada y segura a un servicio con tecnología de Azure Private Link.", comment: "Un punto de conexión privado utiliza una IP privada de tu VNet, lo que permite que el tráfico al servicio de Azure permanezca en la red de Microsoft.", category: C.NETWORK },
            { question: "62. ¿Qué es un grupo de seguridad de aplicaciones (ASG)?", options: ["Un grupo de direcciones IP que se pueden usar en reglas de NSG.", "Una construcción lógica que permite agrupar VMs y definir políticas de seguridad de red basadas en esas agrupaciones.", "Un grupo de Azure AD para asignar permisos de red.", "Un tipo de firewall de aplicaciones."], answer: "Una construcción lógica que permite agrupar VMs y definir políticas de seguridad de red basadas en esas agrupaciones.", comment: "Los ASG te permiten configurar la seguridad de la red como una extensión natural de la estructura de una aplicación, agrupando las VMs por carga de trabajo.", category: C.NETWORK },
            { question: "63. Necesitas asegurar que una aplicación en un VMSS mantenga un estado de sesión consistente. ¿Qué configuración del balanceador de carga deberías usar?", options: ["Reglas NAT de entrada.", "Sondeos de estado (Health Probes).", "Persistencia de sesión (Afinidad de sesión) configurada como `SourceIP`.", "Reglas de salida."], answer: "Persistencia de sesión (Afinidad de sesión) configurada como `SourceIP`.", comment: "La afinidad de sesión dirige todo el tráfico de un cliente a la misma instancia de VM en el backend durante la sesión.", category: C.NETWORK },
            { question: "65. ¿Qué método de enrutamiento de Traffic Manager mejora el rendimiento al reducir la latencia para los usuarios finales?", options: ["Prioridad", "Ponderado", "Rendimiento", "Geográfico"], answer: "Rendimiento", comment: "El perfil de enrutamiento de Rendimiento está diseñado para mejorar la capacidad de respuesta de la aplicación al dirigir el tráfico al punto de conexión con la latencia más baja.", category: C.NETWORK },
            { question: "69. ¿Qué herramienta de Network Watcher te permite verificar si se permite o deniega el tráfico entre una VM y un destino específico?", options: ["Topología", "Verificación de flujo de IP (IP Flow Verify)", "Próximo salto (Next Hop)", "Captura de paquetes"], answer: "Verificación de flujo de IP (IP Flow Verify)", comment: "Esta herramienta te ayuda a diagnosticar rápidamente problemas de conectividad al indicarte si el tráfico está siendo bloqueado por una regla de NSG.", category: C.NETWORK },
            { question: "73. ¿Cómo puedes forzar todo el tráfico de salida de una subred a través de una NVA para su inspección?", options: ["Configurando una regla de NSG para redirigir el tráfico.", "Creando una tabla de rutas con una UDR que dirija el tráfico `0.0.0.0/0` a la IP de la NVA.", "Usando un Application Gateway.", "Habilitando el reenvío de IP en la NVA."], answer: "Creando una tabla de rutas con una UDR que dirija el tráfico `0.0.0.0/0` a la IP de la NVA.", comment: "Esta técnica, conocida como 'túnel forzado', es común en arquitecturas de red seguras para inspeccionar todo el tráfico saliente.", category: C.NETWORK },
            { question: "81. ¿Qué es el 'reenvío de IP' (IP Forwarding) en una NIC de Azure?", options: ["Una configuración que permite a una VM recibir tráfico no destinado a su propia IP.", "Una forma de redirigir el tráfico a otra VM.", "Una configuración de equilibrio de carga.", "Una regla de firewall."], answer: "Una configuración que permite a una VM recibir tráfico no destinado a su propia IP.", comment: "Esta opción es crucial para las aplicaciones virtuales de red (NVA), como firewalls o balanceadores de carga, que necesitan procesar tráfico.", category: C.NETWORK },
            { question: "86. ¿Qué es una regla de 'salida' (Outbound Rule) en un Azure Load Balancer Estándar?", options: ["Una regla que permite el tráfico entrante desde Internet.", "Una regla que define cómo se traduce la dirección de red de origen (SNAT) para el tráfico saliente.", "Una regla que sondea el estado de las VMs del backend.", "Una regla que distribuye el tráfico entrante."], answer: "Una regla que define cómo se traduce la dirección de red de origen (SNAT) para el tráfico saliente.", comment: "Las reglas de salida proporcionan un control explícito y escalable sobre la conectividad a Internet saliente para los recursos de una VNet.", category: C.NETWORK },
            { question: "90. ¿Qué es el 'sondeo de estado' (Health Probe) en un Azure Load Balancer?", options: ["Una herramienta para verificar la latencia de la red.", "Un mecanismo que utiliza el balanceador de carga para detectar el estado de las instancias en el grupo de backend.", "Un informe sobre el estado de la plataforma Azure.", "Una regla de alerta de métrica."], answer: "Un mecanismo que utiliza el balanceador de carga para detectar el estado de las instancias en el grupo de backend.", comment: "El balanceador de carga solo envía tráfico a las instancias que responden correctamente al sondeo de estado.", category: C.NETWORK },
            { question: "94. ¿Qué es el 'peering de circuito' (Circuit Peering) en Azure ExpressRoute?", options: ["La conexión física entre tu red y la de Microsoft.", "Las diferentes sesiones de enrutamiento BGP que se establecen a través de un circuito ExpressRoute (peering privado y de Microsoft).", "La conexión entre dos circuitos ExpressRoute.", "La conexión de un circuito ExpressRoute a una VNet."], answer: "Las diferentes sesiones de enrutamiento BGP que se establecen a través de un circuito ExpressRoute (peering privado y de Microsoft).", comment: "Cada tipo de peering es una sesión de enrutamiento BGP independiente que proporciona acceso a diferentes conjuntos de servicios de Microsoft.", category: C.NETWORK },
            { question: "99. ¿Qué es la 'afinidad de sesión' en Azure Application Gateway?", options: ["Una característica que garantiza que todas las solicitudes de un cliente durante una sesión se dirijan a la misma instancia de servidor backend.", "Una regla que dirige el tráfico a la región más cercana.", "Una configuración de seguridad que bloquea sesiones maliciosas.", "Una métrica que mide la duración de la sesión del usuario."], answer: "Una característica que garantiza que todas las solicitudes de un cliente durante una sesión se dirijan a la misma instancia de servidor backend.", comment: "Esto es importante para aplicaciones que almacenan datos de sesión en el servidor, garantizando una experiencia de usuario consistente.", category: C.NETWORK },

            // Módulo 5: Monitorización y Mantenimiento (20 preguntas)
            { question: "41. ¿Qué servicio de Azure se utiliza para recopilar, analizar y actuar sobre los datos de telemetría de tus entornos?", options: ["Azure Advisor", "Azure Monitor", "Microsoft Defender for Cloud", "Azure Service Health"], answer: "Azure Monitor", comment: "Azure Monitor es la plataforma de supervisión centralizada de Azure que recopila métricas y registros de la mayoría de los servicios de Azure.", category: C.MONITOR },
            { question: "42. En Azure Monitor, ¿cuál es la diferencia fundamental entre Métricas y Registros?", options: ["Las métricas son numéricas y se recopilan a intervalos regulares; los registros contienen varios tipos de datos y se consultan con KQL.", "Las métricas son para la facturación y los registros son para la seguridad.", "Las métricas solo provienen de VMs y los registros de todos los demás servicios.", "No hay ninguna diferencia, son dos nombres para lo mismo."], answer: "Las métricas son numéricas y se recopilan a intervalos regulares; los registros contienen varios tipos de datos y se consultan con KQL.", comment: "Las métricas son ligeras y para escenarios casi en tiempo real. Los registros (en Log Analytics) son para un análisis más profundo y complejo.", category: C.MONITOR },
            { question: "43. Necesitas recibir un email cuando la CPU de una VM supere el 90% durante 5 minutos. ¿Qué deberías configurar?", options: ["Un panel (Dashboard).", "Una consulta de Log Analytics.", "Una regla de alerta de métrica (Metric Alert Rule).", "Un libro (Workbook)."], answer: "Una regla de alerta de métrica (Metric Alert Rule).", comment: "Las reglas de alerta de métricas evalúan las métricas de los recursos a intervalos regulares y activan una alerta cuando se cumple una condición.", category: C.MONITOR },
            { question: "44. ¿Qué es un almacén de Recovery Services (Recovery Services vault)?", options: ["Una cuenta de almacenamiento para archivos de registro.", "Un recurso que almacena datos de copia de seguridad y puntos de recuperación para VMs y SQL Server en VMs.", "Un lugar para almacenar secretos y claves de cifrado.", "Un repositorio para plantillas de ARM."], answer: "Un recurso que almacena datos de copia de seguridad y puntos de recuperación para VMs y SQL Server en VMs.", comment: "Es la entidad de almacenamiento central para Azure Backup y Azure Site Recovery.", category: C.MONITOR },
            { question: "45. ¿Qué es una directiva de copia de seguridad (Backup Policy) en Azure Backup?", options: ["Una directiva de Azure que define qué VMs se pueden respaldar.", "Un conjunto de reglas que definen cuándo se realizan las copias de seguridad y durante cuánto tiempo se retienen.", "Un script que ejecuta la copia de seguridad.", "Un rol RBAC para administrar las copias de seguridad."], answer: "Un conjunto de reglas que definen cuándo se realizan las copias de seguridad y durante cuánto tiempo se retienen.", comment: "Las directivas de copia de seguridad proporcionan una forma de estandarizar y automatizar la protección de datos para grupos de recursos similares.", category: C.MONITOR },
            { question: "46. ¿Qué tipo de restauración de Azure VM Backup te permite restaurar archivos y carpetas individuales sin restaurar toda la VM?", options: ["Restauración completa de la VM.", "Restauración de disco.", "Recuperación a nivel de elemento (Item-Level Recovery).", "Reimplementación de la VM."], answer: "Recuperación a nivel de elemento (Item-Level Recovery).", comment: "La recuperación a nivel de elemento permite montar los discos de un punto de recuperación como unidades y luego explorar y copiar archivos individuales.", category: C.MONITOR },
            { question: "47. ¿Qué herramienta de Azure Monitor se utiliza para crear visualizaciones interactivas y ricas en datos?", options: ["Alertas (Alerts)", "Métricas (Metrics)", "Libros (Workbooks)", "Registros de actividad (Activity Logs)"], answer: "Libros (Workbooks)", comment: "Los libros combinan texto, consultas de análisis, métricas de Azure y parámetros en informes interactivos enriquecidos.", category: C.MONITOR },
            { question: "48. ¿Qué información se encuentra en el Registro de Actividad (Activity Log) de Azure?", options: ["Métricas de rendimiento de las VMs.", "Registros de eventos de aplicaciones que se ejecutan en las VMs.", "Registros a nivel de suscripción sobre eventos del plano de control, como la creación de un nuevo recurso.", "Consultas DNS realizadas en una VNet."], answer: "Registros a nivel de suscripción sobre eventos del plano de control, como la creación de un nuevo recurso.", comment: "El registro de actividad registra quién, qué y cuándo para cualquier operación de escritura (PUT, POST, DELETE) realizada en los recursos.", category: C.MONITOR },
            { question: "49. ¿Para qué se utiliza Azure Service Health?", options: ["Para monitorizar el rendimiento de tus propias aplicaciones.", "Para proporcionar información personalizada sobre cómo los problemas de la plataforma Azure pueden afectarte.", "Para analizar los costos de los servicios de Azure.", "Para realizar copias de seguridad de los servicios de Azure."], answer: "Para proporcionar información personalizada sobre cómo los problemas de la plataforma Azure pueden afectarte.", comment: "Service Health te mantiene informado sobre la salud de la plataforma Azure y su impacto en tus recursos específicos.", category: C.MONITOR },
            { question: "50. Necesitas analizar registros de diagnóstico de varios recursos en un solo lugar con un lenguaje de consulta avanzado. ¿A dónde deberías enviarlos?", options: ["A una cuenta de Azure Storage.", "A un Azure Event Hub.", "A un área de trabajo de Log Analytics.", "A una dirección de correo electrónico."], answer: "A un área de trabajo de Log Analytics.", comment: "Un área de trabajo de Log Analytics es el entorno principal para almacenar y analizar datos de registro de Azure Monitor utilizando KQL.", category: C.MONITOR, subtopic: "Consulta y análisis de registros en Azure Monitor" },
            { question: "53. ¿Cuál es el propósito principal de Network Watcher?", options: ["Proteger la red contra ataques DDoS.", "Proporcionar herramientas para supervisar, diagnosticar y ver métricas para los recursos en una red virtual.", "Conectar redes locales a Azure.", "Filtrar el tráfico web malicioso."], answer: "Proporcionar herramientas para supervisar, diagnosticar y ver métricas para los recursos en una red virtual.", comment: "Network Watcher incluye herramientas como Verificación de flujo de IP, Próximo salto y Captura de paquetes para solucionar problemas de conectividad.", category: C.NETWORK },
            { question: "55. ¿Qué es el 'soft delete' para Azure Virtual Machines?", options: ["Una característica que mueve las VMs eliminadas a una papelera de reciclaje.", "Una característica de Azure Backup que retiene los datos de copia de seguridad de una VM eliminada durante 14 días.", "Un tipo de bloqueo de recursos.", "Una política de Azure que previene la eliminación de VMs."], answer: "Una característica de Azure Backup que retiene los datos de copia de seguridad de una VM eliminada durante 14 días.", comment: "La eliminación temporal es una característica de seguridad clave en Azure Backup que ayuda a recuperar datos de copia de seguridad incluso si son eliminados.", category: C.MONITOR },
            { question: "71. ¿Qué es Azure Advisor?", options: ["Un servicio de soporte técnico de pago.", "Un consultor de nube que ayuda a seguir las mejores prácticas para optimizar las implementaciones de Azure.", "Una herramienta para migrar recursos a Azure.", "Un servicio para monitorizar el estado de la plataforma Azure."], answer: "Un consultor de nube que ayuda a seguir las mejores prácticas para optimizar las implementaciones de Azure.", comment: "Azure Advisor analiza la configuración de tus recursos para proporcionar recomendaciones personalizadas y accionables.", category: C.ID_GOV },
            { question: "78. ¿Qué es un grupo de acciones (Action Group) en Azure Monitor?", options: ["Un grupo de recursos de Azure.", "Una colección de preferencias de notificación y acciones que se pueden desencadenar por una alerta.", "Un grupo de usuarios que pueden ver las alertas.", "Un conjunto de reglas de alerta."], answer: "Una colección de preferencias de notificación y acciones que se pueden desencadenar por una alerta.", comment: "Los grupos de acciones permiten definir acciones reutilizables como enviar un correo electrónico, un SMS, llamar a un webhook, etc., cuando se dispara una alerta.", category: C.MONITOR, subtopic: "Configuración de grupos de acciones en Azure Monitor" },
            { question: "82. ¿Qué es Azure Site Recovery (ASR)?", options: ["Un servicio de copia de seguridad para sitios web.", "Un servicio que contribuye a tu estrategia de recuperación ante desastres (DR) al orquestar la replicación y conmutación por error.", "Una herramienta para recuperar sitios web eliminados.", "Un servicio de monitorización del tiempo de actividad del sitio web."], answer: "Un servicio que contribuye a tu estrategia de recuperación ante desastres (DR) al orquestar la replicación y conmutación por error.", comment: "ASR ayuda a garantizar la continuidad del negocio al mantener las cargas de trabajo en funcionamiento durante las interrupciones.", category: C.MONITOR },
            { question: "87. ¿Qué es 'Azure Cost Management + Billing'?", options: ["Un servicio para pagar tus facturas de Azure.", "Un conjunto de herramientas que te ayudan a analizar, administrar y optimizar tus costos de Azure.", "Un servicio para crear presupuestos para recursos.", "Todas las anteriores."], answer: "Todas las anteriores.", comment: "Es el centro para todo lo relacionado con la gestión financiera de tu entorno de Azure, desde el análisis de costos hasta el pago de facturas.", category: C.ID_GOV },
            { question: "92. ¿Qué modo de conexión de Azure Arc permite la gestión en tiempo real de un servidor local desde Azure?", options: ["Modo desconectado", "Modo conectado", "Modo híbrido", "Modo de solo inventario"], answer: "Modo conectado", comment: "En el modo conectado, el agente de Azure Connected Machine mantiene una conexión constante con Azure, lo que permite escenarios de gestión en tiempo real.", category: C.ID_GOV },
            { question: "98. ¿Qué es el 'análisis de cambios' (Change Analysis) en Azure Monitor?", options: ["Un registro de los cambios de costos en Azure.", "Una herramienta que ayuda a identificar qué cambios en los recursos de Azure podrían haber causado un problema.", "Un análisis de los cambios en el código fuente de una aplicación.", "Un registro de los cambios de roles RBAC."], answer: "Una herramienta que ayuda a identificar qué cambios en los recursos de Azure podrían haber causado un problema.", comment: "El análisis de cambios se basa en los datos de Azure Resource Graph para proporcionar información sobre los cambios en la infraestructura.", category: C.MONITOR },
            { question: "95. ¿Qué es el 'acceso basado en el punto final' (Endpoint-based access) en Azure Policy?", options: ["Una forma de aplicar políticas a los puntos de conexión de servicio.", "Una forma de aplicar políticas a los puntos de conexión privados.", "No es un término estándar de Azure Policy.", "Una política que restringe qué tipos de puntos de conexión se pueden crear."], answer: "No es un término estándar de Azure Policy.", comment: "Las políticas se aplican a ámbitos (grupos de administración, suscripciones, etc.) y tipos de recursos, no directamente a 'puntos de conexión'.", category: C.ID_GOV }
        ];

        // Eliminar pregunta duplicada (pregunta 95)
        for (let i = originalQuizData.length - 1; i >= 0; i--) {
            if (originalQuizData[i].question.startsWith("95.")) {
                originalQuizData.splice(i, 1);
                break; // Solo eliminar la segunda aparición
            }
        }
        // Agregar nueva pregunta 95 sobre Azure Blueprints
        originalQuizData.push({
            question: "95. ¿Qué es Azure Blueprints y para qué se utiliza?",
            options: [
                "Un servicio para crear y administrar copias de seguridad de recursos.",
                "Una herramienta para automatizar la implementación de entornos completos de Azure siguiendo políticas y controles de gobernanza.",
                "Un sistema de monitoreo de costos en Azure.",
                "Un servicio para la gestión de identidades externas."
            ],
            answer: "Una herramienta para automatizar la implementación de entornos completos de Azure siguiendo políticas y controles de gobernanza.",
            comment: "Azure Blueprints permite definir un conjunto de recursos, políticas, roles y plantillas ARM para implementar y gobernar entornos de Azure de manera repetible y segura.",
            category: C.ID_GOV,
            subtopic: "Implementación y administración de Azure Blueprints"
        });

        // Revisión y asignación de subtema a todas las preguntas sin subtopic
        for (let i = 0; i < originalQuizData.length; i++) {
            if (!originalQuizData[i].subtopic || originalQuizData[i].subtopic === 'Otro' || originalQuizData[i].subtopic === 'Sin subtema asignado') {
                // Asignar subtema por categoría como fallback genérico
                if (originalQuizData[i].category === C.ID_GOV) {
                    originalQuizData[i].subtopic = 'Gobernanza y administración de identidades en Azure';
                } else if (originalQuizData[i].category === C.STORAGE) {
                    originalQuizData[i].subtopic = 'Administración y configuración de almacenamiento en Azure';
                } else if (originalQuizData[i].category === C.COMPUTE) {
                    originalQuizData[i].subtopic = 'Administración y configuración de recursos de cómputo en Azure';
                } else if (originalQuizData[i].category === C.NETWORK) {
                    originalQuizData[i].subtopic = 'Administración y configuración de redes virtuales en Azure';
                } else if (originalQuizData[i].category === C.MONITOR) {
                    originalQuizData[i].subtopic = 'Supervisión y mantenimiento de recursos en Azure';
                } else {
                    originalQuizData[i].subtopic = 'General de Azure';
                }
            }
        }

        // --- STATE ---
        let quizData = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let markedQuestions = [];
        let selectedOption = null;
        let inReviewMode = false;
        let startTime;
        let currentTheme = localStorage.getItem('theme') || 'system';

        // --- DOM ELEMENTS ---
        const quizContainer = document.getElementById('quiz-container');
        const resultContainer = document.getElementById('result-container');
        const navigationControls = document.getElementById('navigation-controls');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const checkBtn = document.getElementById('check-btn');
        const viewModal = document.getElementById('view-modal');
        const summaryListsContainer = document.getElementById('summary-lists');
        const confirmModal = document.getElementById('confirm-modal');
        const quantityModal = document.getElementById('quantity-modal');
        const mainQuizContent = document.getElementById('main-quiz-content');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const quantityButtonsContainer = document.getElementById('quantity-buttons');
        const questionCategoryElement = document.getElementById('question-category');

        // --- FUNCTIONS ---

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function selectQuantity(quantity) {
            quantityModal.classList.add('hidden');
            mainQuizContent.classList.remove('hidden');
            startGame(quantity);
        }
        
        function startGame(numQuestions) {
            inReviewMode = false;
            quizData = shuffle([...originalQuizData]).slice(0, numQuestions);
            currentQuestionIndex = 0;
            userAnswers = Array(quizData.length).fill(null);
            markedQuestions = Array(quizData.length).fill(false);
            selectedOption = null;
            startTime = new Date();
            
            resultContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            navigationControls.classList.remove('hidden');
            document.querySelector('header').classList.remove('hidden');
            
            updateProgressBarVisual();
            loadQuestion();
        }

        function startReview() {
            if (!quizData || !quizData.length) {
                console.error('No hay preguntas para revisar');
                return;
            }
            inReviewMode = true;
            currentQuestionIndex = 0;
            resultContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            navigationControls.classList.remove('hidden');
            document.querySelector('header').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            if (!quizData || !quizData.length || !quizData[currentQuestionIndex]) {
                console.error('No hay preguntas cargadas o el índice es inválido');
                return;
            }
            
            selectedOption = null; 
            const questionData = quizData[currentQuestionIndex];
            
            questionCategoryElement.textContent = questionData.category;

            let optionsToDisplay = [...questionData.options];
            if (!inReviewMode && userAnswers[currentQuestionIndex] === null) {
                optionsToDisplay = shuffle(optionsToDisplay);
            }

            let optionsHtml = optionsToDisplay.map((option, index) => {
                const optionLetter = String.fromCharCode(65 + index);
                const escapedOption = option.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                return `<button class="option-btn w-full text-left p-4 border-2 rounded-lg dark:border-gray-600 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100 transition-all duration-200" data-option-value="${escapedOption}">${optionLetter}. ${option}</button>`;
            }).join('');

            quizContainer.innerHTML = `
                <div class="question-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">${questionData.question}</h2>
                        <button onclick="toggleMarkQuestion()" id="mark-btn" class="text-2xl ${markedQuestions[currentQuestionIndex] ? 'marked' : 'text-gray-400'} hover:text-amber-500 transition-colors">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </div>
                    <div class="options-container space-y-3">${optionsHtml}</div>
                    <div id="feedback-${currentQuestionIndex}" class="feedback mt-4 p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
                        <p class="font-bold text-gray-900 dark:text-gray-100">Comentario:</p>
                        <p class="text-gray-900 dark:text-gray-100">${questionData.comment}</p>
                    </div>
                </div>
            `;
            
            quizContainer.querySelectorAll('.option-btn').forEach(button => {
                button.addEventListener('click', () => selectOption(button, button.dataset.optionValue));
            });
            
            updateNavigation();
            
            const isAnswered = userAnswers[currentQuestionIndex] !== null;
            if (isAnswered) {
                const userAnswer = userAnswers[currentQuestionIndex];
                quizContainer.querySelectorAll('.option-btn').forEach(btn => {
                    if (btn.dataset.optionValue === userAnswer) {
                         btn.classList.add('selected');
                    }
                });
                showFeedback(false); 
            }

            if(inReviewMode) {
                document.getElementById('mark-btn').disabled = true;
            }
        }

        function updateNavigation() {
            progressText.textContent = `Pregunta ${currentQuestionIndex + 1} de ${quizData.length}`;
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if(inReviewMode) {
                checkBtn.classList.add('hidden');
                nextBtn.disabled = currentQuestionIndex === quizData.length - 1;
                nextBtn.textContent = (currentQuestionIndex === quizData.length - 1) ? 'Ver Resultados' : 'Siguiente';
            } else {
                checkBtn.classList.remove('hidden');
                checkBtn.disabled = selectedOption === null || userAnswers[currentQuestionIndex] !== null;
                nextBtn.disabled = userAnswers[currentQuestionIndex] === null;
                nextBtn.textContent = 'Siguiente';
            }
        }
        
        function selectOption(btnElement, optionValue) {
            if (userAnswers[currentQuestionIndex] !== null || inReviewMode) return;
            quizContainer.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
            selectedOption = optionValue;
            checkBtn.disabled = false;
        }

        function checkAnswer() {
            if (selectedOption === null || inReviewMode) return;
            userAnswers[currentQuestionIndex] = selectedOption;
            showFeedback(true);
            updateNavigation(); 
            updateProgressBarVisual();
            
            // Auto-desplegar explicación después de un breve delay
            setTimeout(() => {
                const feedbackDiv = document.getElementById(`feedback-${currentQuestionIndex}`);
                if (feedbackDiv && !feedbackDiv.classList.contains('show')) {
                    feedbackDiv.classList.add('show');
                    
                    // Scroll suave hacia la explicación
                    feedbackDiv.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }
            }, 500); // Delay de 500ms para mejor UX
        }
        
        function showFeedback(animate) {
            const questionData = quizData[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            const options = quizContainer.querySelectorAll('.option-btn');
            
            // Deshabilitar todas las opciones
            options.forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.optionValue === questionData.answer) {
                    btn.classList.add('correct');
                } else if (btn.dataset.optionValue === userAnswer) {
                    btn.classList.add('incorrect');
                }
            });
            
            const feedbackDiv = document.getElementById(`feedback-${currentQuestionIndex}`);
            
            // Crear feedback mejorado
            let feedbackHtml = `
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border-l-4 ${
                    userAnswer === questionData.answer ? 'border-green-500' : 'border-red-500'
                }">
            `;
            
            if (userAnswer === questionData.answer) {
                feedbackHtml += `
                    <div class="flex items-center mb-3">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <p class='font-bold text-green-600 text-lg'>¡Respuesta correcta!</p>
                    </div>
                `;
            } else {
                feedbackHtml += `
                    <div class="flex items-center mb-3">
                        <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <p class='font-bold text-red-600 text-lg'>Respuesta incorrecta</p>
                    </div>
                    <div class="mb-3">
                        <p class='text-sm'><span class='font-bold text-red-600'>Tu respuesta:</span> ${userAnswer || 'Sin respuesta'}</p>
                        <p class='text-sm'><span class='font-bold text-green-600'>Respuesta correcta:</span> ${questionData.answer}</p>
                    </div>
                `;
            }
            
            feedbackHtml += `
                <div class="space-y-2">
                    <p class='text-sm text-gray-700 dark:text-gray-300'><span class='font-bold'>Comentario:</span> ${questionData.comment}</p>
                    <p class='text-xs text-blue-700 dark:text-blue-300'><span class='font-bold'>Tema:</span> ${questionData.category}</p>
                    <p class='text-xs text-indigo-700 dark:text-indigo-300'><span class='font-bold'>Subtema:</span> ${questionData.subtopic && questionData.subtopic !== 'Otro' ? questionData.subtopic : 'Sin subtema asignado'}</p>
                </div>
            </div>
            `;
            
            feedbackDiv.innerHTML = feedbackHtml;
            
            if (animate) {
                // Auto-desplegar con animación
                setTimeout(() => {
                    feedbackDiv.classList.add('show');
                    
                    // Scroll suave hacia la explicación
                    feedbackDiv.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest',
                        inline: 'nearest'
                    });
                }, 300);
            } else {
                // Mostrar inmediatamente (modo review)
                feedbackDiv.style.maxHeight = '300px';
                feedbackDiv.style.paddingTop = '1.5rem';
                feedbackDiv.style.paddingBottom = '1.5rem';
                feedbackDiv.style.opacity = '1';
                feedbackDiv.style.transform = 'translateY(0)';
                feedbackDiv.classList.add('show');
            }
        }
        
        function toggleMarkQuestion() {
            if (inReviewMode) return;
            const markBtn = document.getElementById('mark-btn');
            markedQuestions[currentQuestionIndex] = !markedQuestions[currentQuestionIndex];
            markBtn.classList.toggle('marked');
            markBtn.classList.toggle('text-gray-400');
        }

        function nextQuestion() {
            if (inReviewMode) {
                if (currentQuestionIndex < quizData.length - 1) {
                    currentQuestionIndex++;
                    loadQuestion();
                } else {
                    showResults();
                }
                return;
            }
            
            if (userAnswers[currentQuestionIndex] === null) {
                userAnswers[currentQuestionIndex] = "No contestada"; 
            }
            
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                confirmFinishTest();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }
        
        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            loadQuestion();
            toggleViewModal();
        }

        function showResults() {
            quizContainer.classList.add('hidden');
            resultContainer.classList.remove('hidden');
            navigationControls.classList.add('hidden');
            let correctAnswers = 0;
            let incorrectAnswers = 0;
            let unansweredCount = 0;
            const categoryScores = {};
            const subtopicScores = {};
            Object.values(C).forEach(catName => {
                categoryScores[catName] = { correct: 0, total: 0 };
            });
            // Guardar preguntas falladas
            let wrongQuestions = [];
            userAnswers.forEach((answer, index) => {
                const questionData = quizData[index];
                const category = questionData.category;
                const subtopic = (questionData.subtopic && questionData.subtopic !== 'Otro') ? questionData.subtopic : 'Sin subtema asignado';
                categoryScores[category].total++;
                if (!subtopicScores[category]) subtopicScores[category] = {};
                if (!subtopicScores[category][subtopic]) subtopicScores[category][subtopic] = { correct: 0, total: 0 };
                subtopicScores[category][subtopic].total++;
                if (answer === "No contestada") {
                    unansweredCount++;
                } else if (answer === questionData.answer) {
                    correctAnswers++;
                    categoryScores[category].correct++;
                    subtopicScores[category][subtopic].correct++;
                } else {
                    incorrectAnswers++;
                    wrongQuestions.push({
                        question: questionData.question,
                        userAnswer: answer,
                        correctAnswer: questionData.answer,
                        comment: questionData.comment,
                        category: questionData.category,
                        subtopic: subtopic
                    });
                }
            });
            const totalQuestions = quizData.length;
            const percentage = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(2) : 0;
            const endTime = new Date();
            const durationMs = endTime - startTime;
            const minutes = Math.floor(durationMs / 60000);
            const seconds = ((durationMs % 60000) / 1000).toFixed(0);
            const durationString = `${minutes}m ${seconds}s`;
            document.getElementById('result-details').innerHTML = `
                <span class="text-green-500 font-bold">Acertadas: ${correctAnswers}</span> | 
                <span class="text-red-500 font-bold">Incorrectas: ${incorrectAnswers}</span> |
                <span class="text-gray-500 font-bold">Sin contestar: ${unansweredCount}</span><br>
                <span class="text-gray-700 dark:text-gray-300 font-bold">Duración: ${durationString}</span>
            `;
            const scorePercentageEl = document.getElementById('score-percentage');
            const resultMessageEl = document.getElementById('result-message');
            scorePercentageEl.textContent = `${percentage}%`;
            if (percentage >= 70) {
                resultMessageEl.textContent = "¡Aprobado!";
                resultMessageEl.className = "text-2xl font-semibold text-green-500";
                scorePercentageEl.className = "text-4xl font-bold mb-2 text-green-500";
            } else {
                resultMessageEl.textContent = "Necesitas repasar";
                resultMessageEl.className = "text-2xl font-semibold text-red-500";
                scorePercentageEl.className = "text-4xl font-bold mb-2 text-red-500";
            }
            // --- Render Category Results ---
            const categoryResultsEl = document.getElementById('category-results');
            categoryResultsEl.innerHTML = '';
            for (const categoryName in categoryScores) {
                const score = categoryScores[categoryName];
                if (score.total > 0) {
                    const catPercentage = ((score.correct / score.total) * 100);
                    const catPercentageFormatted = catPercentage.toFixed(0);
                    const barColor = catPercentage >= 70 ? 'bg-green-500' : (catPercentage >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                    categoryResultsEl.innerHTML += `
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-md font-medium text-gray-800 dark:text-gray-200">${categoryName}</span>
                                <span class="text-sm font-semibold text-gray-600 dark:text-gray-300">${score.correct} / ${score.total}</span>
                            </div>
                            <div class="category-progress h-6 w-full">
                                <div class="category-progress-bar ${barColor}" style="width: ${catPercentageFormatted}%">
                                    ${catPercentageFormatted}%
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            // Sugerir subtemas a reforzar
            let subtemasRefuerzo = {};
            for (const categoryName in subtopicScores) {
                for (const subtopic in subtopicScores[categoryName]) {
                    const score = subtopicScores[categoryName][subtopic];
                    if (score.total > 0 && ((score.correct / score.total) * 100) < 70) {
                        if (!subtemasRefuerzo[categoryName]) subtemasRefuerzo[categoryName] = [];
                        subtemasRefuerzo[categoryName].push(subtopic);
                    }
                }
            }
            if (Object.keys(subtemasRefuerzo).length > 0) {
                let refuerzoHtml = `<div class='mt-8 text-left'><h3 class='text-xl font-bold mb-4 text-center text-yellow-600'>Temas y subtemas a reforzar</h3>`;
                for (const cat in subtemasRefuerzo) {
                    refuerzoHtml += `<div class='mb-2'><span class='font-bold text-blue-700 dark:text-blue-300'>${cat}</span><ul class='list-disc pl-6'>`;
                    subtemasRefuerzo[cat].forEach(sub => {
                        refuerzoHtml += `<li class='text-indigo-700 dark:text-indigo-300'>${sub}</li>`;
                    });
                    refuerzoHtml += `</ul></div>`;
                }
                refuerzoHtml += `</div>`;
                categoryResultsEl.innerHTML += refuerzoHtml;
            }
        }
        
        function restartGame() {
            const quantityModal = document.getElementById('quantity-modal');
            const mainQuizContent = document.getElementById('main-quiz-content');
            if (quantityModal) quantityModal.classList.remove('hidden');
            if (mainQuizContent) mainQuizContent.classList.add('hidden');
        }

        function toggleViewModal() {
            if (viewModal.classList.contains('hidden')) {
                updateViewModalLists();
                viewModal.classList.remove('hidden');
                setTimeout(() => {
                    viewModal.classList.add('opacity-100');
                    viewModal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            } else {
                viewModal.classList.remove('opacity-100');
                viewModal.querySelector('.modal-container').classList.add('scale-95');
                setTimeout(() => viewModal.classList.add('hidden'), 300);
            }
        }

        function updateViewModalLists() {
            summaryListsContainer.innerHTML = '';
            const lists = {
                'Sin Contestar': [],
                'Contestadas': [],
                'Marcadas para Revisar': []
            };

            quizData.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.textContent = index + 1;
                btn.className = 'h-10 w-10 flex items-center justify-center rounded font-bold transition relative';
                btn.onclick = () => jumpToQuestion(index);

                const isAnswered = userAnswers[index] !== null && userAnswers[index] !== "No contestada";
                
                if (isAnswered) {
                    btn.classList.add('bg-green-200', 'text-green-800', 'hover:bg-green-300', 'dark:bg-green-800', 'dark:text-green-100', 'dark:hover:bg-green-700');
                    if (userAnswers[index] !== q.answer) {
                        btn.classList.remove('bg-green-200', 'hover:bg-green-300', 'dark:bg-green-800', 'dark:hover:bg-green-700');
                        btn.classList.add('bg-red-200', 'text-red-800', 'hover:bg-red-300', 'dark:bg-red-800', 'dark:text-red-100', 'dark:hover:bg-red-700');
                    }
                    lists['Contestadas'].push(btn);
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'dark:bg-gray-600', 'dark:text-gray-100', 'dark:hover:bg-gray-500');
                    lists['Sin Contestar'].push(btn);
                }

                if (markedQuestions[index]) {
                    const clone = btn.cloneNode(true);
                    clone.onclick = () => jumpToQuestion(index);
                    lists['Marcadas para Revisar'].push(clone);
                }
            });

            for (const [title, buttonList] of Object.entries(lists)) {
                const container = document.createElement('div');
                container.innerHTML = `<h4 class="font-bold mb-2 text-lg border-b pb-1 dark:border-gray-500">${title}</h4>`;
                const listWrapper = document.createElement('div');
                listWrapper.className = 'flex flex-wrap gap-2 justify-start';
                if (buttonList.length > 0) {
                    buttonList.forEach(btn => listWrapper.appendChild(btn));
                } else {
                    listWrapper.innerHTML = '<p class="text-sm text-gray-500 w-full">Ninguna</p>';
                }
                container.appendChild(listWrapper);
                summaryListsContainer.appendChild(container);
            }
        }
        
        function confirmFinishTest() {
            const unansweredCount = userAnswers.filter(a => a === null || a === "No contestada").length;
            document.getElementById('confirm-title').textContent = unansweredCount > 0 ? '¿Finalizar Test?' : '¿Finalizar y ver resultados?';
            document.getElementById('confirm-message').textContent = unansweredCount > 0 ? `Advertencia: Tienes ${unansweredCount} preguntas sin contestar. ¿Estás seguro?` : `Has contestado todas las preguntas. ¿Quieres finalizar?`;
            
            confirmModal.classList.remove('hidden');
            setTimeout(() => confirmModal.querySelector('.modal-container').classList.remove('scale-95'), 10);
        }
        
        function handleFinishConfirmation(confirmed) {
            confirmModal.querySelector('.modal-container').classList.add('scale-95');
            setTimeout(() => confirmModal.classList.add('hidden'), 200);

            if (confirmed) {
                showResults();
                if (!viewModal.classList.contains('hidden')) {
                    toggleViewModal();
                }
            }
        }

        function applyTheme(theme) {
            const htmlEl = document.documentElement;
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            const icon = themeToggleBtn.querySelector('i');

            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                htmlEl.classList.add('dark');
                if (icon) icon.className = 'fas fa-sun';
            } else {
                htmlEl.classList.remove('dark');
                if (icon) icon.className = 'fas fa-moon';
            }
        }

        function toggleTheme() {
            const htmlEl = document.documentElement;
            htmlEl.classList.toggle('dark');
            currentTheme = htmlEl.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            applyTheme(currentTheme);
        }

        function updateProgressBarVisual() {
            let answeredCount = userAnswers.filter(answer => answer !== null && answer !== "No contestada").length;
            const progress = (answeredCount / quizData.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
        }

        window.onload = function() {
            // Solo inicializa si el contenedor del test existe
            var quizContainer = document.getElementById('quiz-container');
            var quantityButtonsContainer = document.getElementById('quantity-buttons');
            var themeToggleBtn = document.getElementById('theme-toggle-btn');
            if (!quizContainer || !quantityButtonsContainer || !themeToggleBtn) return;

            themeToggleBtn.onclick = toggleTheme;
            applyTheme(localStorage.getItem('theme') || 'system');

            quantityButtonsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const quantity = parseInt(event.target.dataset.quantity);
                    selectQuantity(quantity);
                });
            });
        };

        // Asignación de subtemas oficiales a todas las preguntas
        definirSubtemaOficial = (pregunta) => {
          // Subtemas oficiales por categoría
          const subtemasIDGOV = [
            'Administrar usuarios y grupos de Microsoft Entra',
            'Administración de propiedades de usuario y grupo',
            'Administrar licencias en Microsoft Entra ID',
            'Administración de usuarios externos',
            'Configuración del autoservicio de restablecimiento de contraseña (SSPR)',
            'Administración del acceso de usuarios a los recursos de Azure',
            'Administración de roles de Azure integrados',
            'Asignación de roles en distintos ámbitos',
            'Interpretación de las asignaciones de acceso',
            'Administración de suscripciones y gobernanza de Azure',
            'Implementación y administración de Azure Policy',
            'Configuración de bloqueos de recursos',
            'Aplicación y administración de etiquetas en recursos',
            'Administración de grupos de recursos',
            'Administrar suscripciones',
            'Administración de costos mediante alertas, presupuestos y recomendaciones de Azure Advisor',
            'Configuración de grupos de administración'
          ];
          const subtemasSTORAGE = [
            'Configuración del acceso al almacenamiento',
            'Configuración de redes virtuales y firewalls de Azure Storage',
            'Creación y uso de tokens de firma de acceso compartido (SAS)',
            'Configuración de las directivas de acceso almacenadas',
            'Administración de las claves de acceso',
            'Configuración del acceso basado en identidad para Azure Files',
            'Creación y configuración de cuentas de almacenamiento',
            'Configuración de la redundancia de Azure Storage',
            'Configuración de la replicación de objetos',
            'Configuración del cifrado de una cuenta de almacenamiento',
            'Administración de datos mediante Explorador de Azure Storage y AzCopy',
            'Creación y configuración de un recurso compartido de archivos en Azure Storage',
            'Creación y configuración de un contenedor en Blob Storage',
            'Configuración de las capas de almacenamiento',
            'Configuración de la eliminación temporal para blobs y contenedores',
            'Configuración de instantáneas y eliminación temporal para Azure Files',
            'Configuración de la administración del ciclo de vida de los blobs',
            'Configuración del control de versiones de blobs'
          ];
          const subtemasCOMPUTE = [
            'Interpretación de una plantilla de Azure Resource Manager o un archivo de Bicep',
            'Modificación de una plantilla de Azure Resource Manager existente',
            'Modificación de un archivo de Bicep',
            'Implementación de recursos mediante una plantilla de Azure Resource Manager o un archivo de Bicep',
            'Exportación de una implementación como plantilla de Azure Resource Manager o conversión de una plantilla de Azure Resource Manager en un archivo de Bicep',
            'Creación de una máquina virtual',
            'Configuración de Azure Disk Encryption',
            'Traslado de una máquina virtual a otro grupo de recursos, otra suscripción u otra región',
            'Administración de los tamaños de máquina virtual',
            'Administración de discos de máquinas virtuales',
            'Implementación de máquinas virtuales en zonas de disponibilidad y conjuntos de disponibilidad',
            'Implementación y configuración de un conjunto de escalado de máquinas virtuales de Azure',
            'Creación y administración de un registro de contenedor de Azure',
            'Aprovisionamiento de un contenedor con Azure Container Instances',
            'Aprovisionamiento de un contenedor con Azure Container Apps',
            'Administración del ajuste de tamaño y el escalado de contenedores, incluidos Azure Container Instances y Azure Container Apps',
            'Aprovisionamiento de un plan de App Service',
            'Configuración del escalado de un plan de App Service',
            'Crear una instancia de App Service',
            'Configuración de certificados y seguridad de la capa de transporte (TLS) para una instancia de App Service',
            'Asignación de un nombre DNS personalizado a una instancia de App Service',
            'Configuración de una copia de seguridad para una instancia de App Service',
            'Configuración de redes para una instancia de App Service',
            'Configuración de ranuras de implementación para una instancia de App Service'
          ];
          const subtemasNETWORK = [
            'Creación y configuración de redes virtuales y subredes',
            'Creación y configuración del emparejamiento de red virtual',
            'Configuración de direcciones IP públicas',
            'Configuración de rutas de red definidas por el usuario',
            'Solución de problemas de conectividad de red',
            'Creación y configuración de grupos de seguridad de red (NSG) y grupos de seguridad de aplicaciones',
            'Evaluación de reglas de seguridad eficaces en grupos de seguridad de red',
            'Implementación de Azure Bastion',
            'Configuración de puntos de conexión de servicio para la plataforma como servicio (PaaS) Azure',
            'Configuración de puntos de conexión privados para la plataforma como servicio (PaaS) Azure',
            'Configuración de Azure DNS',
            'Configuración de un equilibrador de carga interno o público',
            'Solución de problemas del equilibrio de carga'
          ];
          const subtemasMONITOR = [
            'Interpretación de métricas en Azure Monitor',
            'Configuración de registros en Azure Monitor',
            'Consulta y análisis de registros en Azure Monitor',
            'Configuración de reglas de alertas, grupos de acciones y reglas de procesamiento de alertas en Azure Monitor',
            'Configuración e interpretación de la supervisión de máquinas virtuales, cuentas de almacenamiento y redes con Azure Monitor Insights',
            'Uso de Azure Network Watcher y Connection Monitor',
            'Creación de un almacén de Recovery Services',
            'Creación de un almacén de Azure Backup',
            'Creación y configuración de una directiva de copia de seguridad',
            'Realización de operaciones de copia de seguridad y restauración mediante Azure Backup',
            'Configuración de Azure Site Recovery para recursos de Azure',
            'Realización de una conmutación por error a una región secundaria mediante Site Recovery',
            'Configuración e interpretación de informes y alertas para copias de seguridad'
          ];
          // Lógica de asignación por palabras clave en la pregunta o subtema anterior
          const texto = (pregunta.question + ' ' + (pregunta.subtopic || '')).toLowerCase();
          // ID_GOV
          if (pregunta.category === C.ID_GOV) {
            if (texto.includes('policy')) return 'Implementación y administración de Azure Policy';
            if (texto.includes('grupo de administración')) return 'Configuración de grupos de administración';
            if (texto.includes('etiquet')) return 'Aplicación y administración de etiquetas en recursos';
            if (texto.includes('bloqueo')) return 'Configuración de bloqueos de recursos';
            if (texto.includes('licenc')) return 'Administrar licencias en Microsoft Entra ID';
            if (texto.includes('sspr') || texto.includes('restablecimiento de contraseña')) return 'Configuración del autoservicio de restablecimiento de contraseña (SSPR)';
            if (texto.includes('rol') && texto.includes('rbac')) return 'Administración de roles de Azure integrados';
            if (texto.includes('advisor')) return 'Administración de costos mediante alertas, presupuestos y recomendaciones de Azure Advisor';
            if (texto.includes('blueprint')) return 'Administración de suscripciones y gobernanza de Azure';
            if (texto.includes('grupo de recursos')) return 'Administración de grupos de recursos';
            if (texto.includes('suscrip')) return 'Administrar suscripciones';
            return 'Administración de suscripciones y gobernanza de Azure';
          }
          // STORAGE
          if (pregunta.category === C.STORAGE) {
            if (texto.includes('sas')) return 'Creación y uso de tokens de firma de acceso compartido (SAS)';
            if (texto.includes('azcopy')) return 'Administración de datos mediante Explorador de Azure Storage y AzCopy';
            if (texto.includes('blob')) return 'Creación y configuración de un contenedor en Blob Storage';
            if (texto.includes('redundancia')) return 'Configuración de la redundancia de Azure Storage';
            if (texto.includes('cifrado')) return 'Configuración del cifrado de una cuenta de almacenamiento';
            if (texto.includes('archivo') || texto.includes('file')) return 'Creación y configuración de un recurso compartido de archivos en Azure Storage';
            if (texto.includes('ciclo de vida')) return 'Configuración de la administración del ciclo de vida de los blobs';
            if (texto.includes('instantánea')) return 'Configuración de instantáneas y eliminación temporal para Azure Files';
            if (texto.includes('cuenta de almacenamiento')) return 'Creación y configuración de cuentas de almacenamiento';
            return 'Configuración del acceso al almacenamiento';
          }
          // COMPUTE
          if (pregunta.category === C.COMPUTE) {
            if (texto.includes('bicep') || texto.includes('arm')) return 'Interpretación de una plantilla de Azure Resource Manager o un archivo de Bicep';
            if (texto.includes('máquina virtual') && texto.includes('crea')) return 'Creación de una máquina virtual';
            if (texto.includes('disco') && texto.includes('admin')) return 'Administración de discos de máquinas virtuales';
            if (texto.includes('escalado')) return 'Implementación y configuración de un conjunto de escalado de máquinas virtuales de Azure';
            if (texto.includes('app service')) return 'Aprovisionamiento de un plan de App Service';
            if (texto.includes('container')) return 'Aprovisionamiento de un contenedor con Azure Container Instances';
            if (texto.includes('imagen')) return 'Creación y uso de imágenes de máquina virtual';
            if (texto.includes('backup')) return 'Creación y configuración de una directiva de copia de seguridad';
            return 'Creación y configuración de máquinas virtuales';
          }
          // NETWORK
          if (pregunta.category === C.NETWORK) {
            if (texto.includes('dns')) return 'Configuración de Azure DNS';
            if (texto.includes('bastion')) return 'Implementación de Azure Bastion';
            if (texto.includes('nsg') || texto.includes('seguridad')) return 'Creación y configuración de grupos de seguridad de red (NSG) y grupos de seguridad de aplicaciones';
            if (texto.includes('emparejamiento')) return 'Creación y configuración del emparejamiento de red virtual';
            if (texto.includes('equilibrador')) return 'Configuración de un equilibrador de carga interno o público';
            if (texto.includes('ruta')) return 'Configuración de rutas de red definidas por el usuario';
            if (texto.includes('ip pública')) return 'Configuración de direcciones IP públicas';
            if (texto.includes('privado')) return 'Configuración de puntos de conexión privados para la plataforma como servicio (PaaS) Azure';
            if (texto.includes('servicio')) return 'Configuración de puntos de conexión de servicio para la plataforma como servicio (PaaS) Azure';
            return 'Configuración y administración de redes virtuales en Azure';
          }
          // MONITOR
          if (pregunta.category === C.MONITOR) {
            if (texto.includes('alerta') || texto.includes('grupo de acciones')) return 'Configuración de reglas de alertas, grupos de acciones y reglas de procesamiento de alertas en Azure Monitor';
            if (texto.includes('log analytics') || texto.includes('consulta')) return 'Consulta y análisis de registros en Azure Monitor';
            if (texto.includes('métrica')) return 'Interpretación de métricas en Azure Monitor';
            if (texto.includes('backup')) return 'Creación y configuración de una directiva de copia de seguridad';
            if (texto.includes('site recovery')) return 'Configuración de Azure Site Recovery para recursos de Azure';
            if (texto.includes('network watcher')) return 'Uso de Azure Network Watcher y Connection Monitor';
            return 'Supervisión de recursos en Azure';
          }
          return 'General de Azure';
        };
        for (let i = 0; i < originalQuizData.length; i++) {
          originalQuizData[i].subtopic = definirSubtemaOficial(originalQuizData[i]);
        }

        // Configuración de tu proyecto Firebase
        // Estructura de base de datos unificada por proyectos:
        // projects/az-104/allowed_users/{base64Email}
        // - email, nombre, apellido, pais, ip, timestamp, approved (true/false)
        const firebaseConfig = {
          apiKey: "AIzaSyAdv8kYX6ojZp-SOctuiv4X-yZAsinRPl0",
          authDomain: "autenticacion-98dbb.firebaseapp.com",
          projectId: "autenticacion-98dbb",
          storageBucket: "autenticacion-98dbb.firebasestorage.app",
          messagingSenderId: "393896566390",
          appId: "1:393896566390:web:970fa2fb679775302b0957"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbRef = firebase.database();
        // Variable global para guardar el email tras login
        let emailUsuarioGoogle = null;
        
        // Función para migrar datos antiguos (ejecutar una vez)
        async function migrateOldData() {
          try {
            console.log('🔄 Iniciando migración de datos...');
            
            // Migrar datos de allowed_users raíz a projects/az-104/allowed_users
            const oldAllowedUsers = await dbRef.ref('allowed_users').once('value');
            if (oldAllowedUsers.exists()) {
              console.log('📦 Encontrados datos antiguos, migrando...');
              const oldData = oldAllowedUsers.val();
              let migratedCount = 0;
              
              for (const [key, value] of Object.entries(oldData)) {
                try {
                  // Solo migrar si no existe en la nueva ubicación
                  const newUserRef = await dbRef.ref('projects/az-104/allowed_users/' + key).once('value');
                  if (!newUserRef.exists()) {
                    // Migrar solo con approved, sin status
                    const { status, ...userData } = value;
                    await dbRef.ref('projects/az-104/allowed_users/' + key).set({
                      ...userData,
                      approved: value.approved || false
                    });
                    migratedCount++;
                  }
                } catch (error) {
                  console.error(`❌ Error migrando usuario ${key}:`, error);
                }
              }
              
              // Eliminar datos antiguos solo si la migración fue exitosa
              if (migratedCount > 0) {
                await dbRef.ref('allowed_users').remove();
                console.log(`✅ Migrados ${migratedCount} usuarios exitosamente`);
              } else {
                console.log('ℹ️ No se encontraron usuarios nuevos para migrar');
              }
            } else {
              console.log('ℹ️ No se encontraron datos antiguos para migrar');
            }
            
            // Eliminar pending_requests raíz (ya no se usa)
            try {
              const pendingRequests = await dbRef.ref('pending_requests').once('value');
              if (pendingRequests.exists()) {
                await dbRef.ref('pending_requests').remove();
                console.log('✅ Datos de pending_requests eliminados');
              }
            } catch (error) {
              console.log('ℹ️ No se encontraron datos de pending_requests');
            }
            
            // Limpiar campo 'status' de datos existentes en projects/az-104/allowed_users
            try {
              const existingUsers = await dbRef.ref('projects/az-104/allowed_users').once('value');
              if (existingUsers.exists()) {
                const usersData = existingUsers.val();
                let cleanedCount = 0;
                
                for (const [key, value] of Object.entries(usersData)) {
                  if (value.status !== undefined) {
                    // Remover campo status y mantener solo approved
                    const { status, ...cleanData } = value;
                    await dbRef.ref('projects/az-104/allowed_users/' + key).set(cleanData);
                    cleanedCount++;
                  }
                }
                
                if (cleanedCount > 0) {
                  console.log(`✅ Campo "status" eliminado de ${cleanedCount} usuarios`);
                } else {
                  console.log('ℹ️ No se encontraron campos "status" para limpiar');
                }
              }
            } catch (error) {
              console.error('❌ Error limpiando campo status:', error);
            }
            
            console.log('✅ Migración completada exitosamente');
          } catch (error) {
            console.error('❌ Error durante la migración:', error);
          }
        }
        
        // Ejecutar migración una vez al cargar la página
        // - Migra datos de allowed_users raíz a projects/az-104/allowed_users
        // - Elimina pending_requests raíz
        // - Limpia campo 'status' y mantiene solo 'approved'
        migrateOldData();
        
        // Función para probar la conexión con Telegram
        async function testTelegramConnection() {
          try {
            const TELEGRAM_BOT_TOKEN = '8046438946:AAHh1m7uiJrmYZiiaTpKjxBLKkAeHna0QAI';
            const TELEGRAM_CHAT_ID = '568985065';
            const testMessage = encodeURIComponent('🧪 Test de conexión - Bot funcionando correctamente');
            
            console.log('🧪 Probando conexión con Telegram...');
            const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${testMessage}`);
            
            if (response.ok) {
              const result = await response.json();
              if (result.ok) {
                console.log('✅ Conexión con Telegram exitosa');
              } else {
                console.error('❌ Error en bot de Telegram:', result);
              }
            } else {
              console.error('❌ Error HTTP en conexión Telegram:', response.status);
            }
          } catch (error) {
            console.error('❌ Error probando conexión Telegram:', error);
          }
        }
        
        // Probar conexión al cargar la página (opcional)
        // testTelegramConnection();
        
        // Exponer función de prueba en consola para debugging
        window.testTelegram = testTelegramConnection;

        function loginGoogle() {
          const provider = new firebase.auth.GoogleAuthProvider();
          // Agregar scopes específicos para mayor seguridad
          provider.addScope('email');
          provider.addScope('profile');
          
          auth.signInWithPopup(provider)
            .then(async (result) => {
              const user = result.user;
              
              // Validar que el usuario tenga email
              if (!user.email) {
                alert('Error: No se pudo obtener el email del usuario');
                auth.signOut();
                return;
              }
              
              // Validar formato de email
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(user.email)) {
                alert('Error: Email inválido');
                auth.signOut();
                return;
              }
              
              emailUsuarioGoogle = user.email;
              const base64Email = btoa(user.email);
              
              try {
                // Verifica el estado del usuario en allowed_users
                const allowedSnap = await dbRef.ref('projects/az-104/allowed_users/' + base64Email).get();
                const allowedData = allowedSnap.exists() ? allowedSnap.val() : null;
                
                if (allowedData) {
                  // Usuario existe en la base de datos
                  if (allowedData.approved === false) {
                    alert('Ya existe una solicitud pendiente para este correo. Por favor espera a que el administrador la revise.');
                    auth.signOut();
                    return;
                  }
                  
                  if (allowedData.approved === true) {
                    // Usuario aprobado - acceso directo
                    const quiz = document.getElementById('main-quiz-content');
                    const login = document.getElementById('login-section');
                    if (quiz) {
                      quiz.style.display = '';
                      quiz.classList.remove('hidden');
                    }
                    if (login) login.style.display = 'none';
                    if (typeof window.quizInitialized === 'undefined') {
                      window.quizInitialized = true;
                      if (typeof startGame === 'function') {
                        startGame(10);
                      }
                    }
                    return;
                  }
                }
                // Si no existe en la base de datos, mostrar formulario
                showExtraDataModal(user.email, user.displayName);
              } catch (error) {
                console.error('Error verificando usuario:', error);
                alert('Error al verificar el estado del usuario. Intenta nuevamente.');
                auth.signOut();
              }
            })
            .catch((error) => {
              console.error('Error de autenticación:', error);
              let errorMessage = 'Error de autenticación';
              
              // Mensajes de error más específicos
              switch (error.code) {
                case 'auth/popup-closed-by-user':
                  errorMessage = 'Inicio de sesión cancelado';
                  break;
                case 'auth/popup-blocked':
                  errorMessage = 'El popup fue bloqueado. Permite popups para este sitio.';
                  break;
                case 'auth/network-request-failed':
                  errorMessage = 'Error de conexión. Verifica tu internet.';
                  break;
                default:
                  errorMessage = error.message || 'Error desconocido';
              }
              
              alert(errorMessage);
            });
        }
        function logout() {
          auth.signOut();
        }
        // Mostrar/ocultar el test según autenticación
        auth.onAuthStateChanged(user => {
          const quiz = document.getElementById('main-quiz-content');
          const login = document.getElementById('login-section');
          const quantityModal = document.getElementById('quantity-modal');
          if (user) {
            const userRef = dbRef.ref('projects/az-104/allowed_users/' + btoa(user.email));
            // Escuchar cambios en el nodo de allowed_users
            let accesoPreviamentePermitido = false;
            userRef.on('value', snapshot => {
              const data = snapshot.val();
              if (data && data.approved === true) {
                accesoPreviamentePermitido = true;
                // Acceso permitido
                if (quiz) {
                  quiz.style.display = '';
                  quiz.classList.remove('hidden');
                }
                if (login) login.style.display = 'none';
                if (quantityModal) quantityModal.classList.remove('hidden');
                if (typeof window.quizInitialized === 'undefined') {
                  window.quizInitialized = true;
                  // No iniciar el test automáticamente, esperar selección del usuario
                }
              } else if (data && data.approved === false) {
                // Solo mostrar mensaje si antes tenía acceso y ahora se lo quitaron
                if (accesoPreviamentePermitido) {
                  alert('Tu acceso ha sido denegado por el administrador.');
                }
                auth.signOut();
              } else {
                // Sin datos o sin aprobar
                if (quiz) {
                  quiz.style.display = 'none';
                  quiz.classList.add('hidden');
                }
                if (login) login.style.display = '';
                window.quizInitialized = undefined;
              }
            });
          } else {
            if (quiz) {
              quiz.style.display = 'none';
              quiz.classList.add('hidden');
            }
            if (login) login.style.display = '';
            if (quantityModal) quantityModal.classList.add('hidden');
            window.quizInitialized = undefined;
          }
        });

        // Mostrar el botón de logout solo si hay usuario
        auth.onAuthStateChanged(user => {
          const btn = document.getElementById('logout-btn');
          if (btn) btn.style.display = user ? '' : 'none';
        });



        // --- AUTENTICACIÓN Y SOLICITUD DE ACCESO ---
        // 
        // ESTRUCTURA UNIFICADA DE BASE DE DATOS:
        // projects/az-104/allowed_users/{base64Email}
        // {
        //   email: "user@example.com",
        //   nombre: "Nombre",
        //   apellido: "Apellido", 
        //   pais: "Chile",
        //   ip: "190.114.38.120",
        //   timestamp: 1753486952201,
        //   approved: false/true
        // }
        //



        // Elementos para el formulario extra de datos
        let extraDataModal = null;
        let extraDataForm = null;
        let extraDataFields = null;

        function showExtraDataModal(email, displayName) {
          if (document.getElementById('extra-data-modal')) {
            document.getElementById('extra-data-modal').classList.remove('hidden');
            return;
          }
          extraDataModal = document.createElement('div');
          extraDataModal.id = 'extra-data-modal';
          extraDataModal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50';
          extraDataModal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6 sm:p-10 animate-fade-in">
              <div class="text-center mb-6">
                <div class="w-12 h-12 sm:w-16 sm:h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-6 h-6 sm:w-8 sm:h-8 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                  </svg>
                </div>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Solicitud de Acceso</h2>
                <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300 mt-2">Completa tus datos para solicitar acceso al test AZ-104</p>
              </div>
              
              <form id="extra-data-form" class="space-y-4 sm:space-y-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <span class="text-red-500">*</span> Nombre
                  </label>
                  <input 
                    type="text" 
                    name="nombre" 
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm sm:text-base" 
                    placeholder="Tu nombre completo"
                    minlength="2"
                    maxlength="50"
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <span class="text-red-500">*</span> Apellido
                  </label>
                  <input 
                    type="text" 
                    name="apellido" 
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm sm:text-base" 
                    placeholder="Tu apellido completo"
                    minlength="2"
                    maxlength="50"
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <span class="text-red-500">*</span> País
                  </label>
                  <select 
                    name="pais" 
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm sm:text-base" 
                    required
                  >
                    <option value="" disabled selected>Selecciona tu país</option>
                    <option value="Argentina">🇦🇷 Argentina</option>
                    <option value="México">🇲🇽 México</option>
                    <option value="España">🇪🇸 España</option>
                    <option value="Colombia">🇨🇴 Colombia</option>
                    <option value="Chile">🇨🇱 Chile</option>
                    <option value="Perú">🇵🇪 Perú</option>
                    <option value="Ecuador">🇪🇨 Ecuador</option>
                    <option value="Uruguay">🇺🇾 Uruguay</option>
                    <option value="Venezuela">🇻🇪 Venezuela</option>
                    <option value="Bolivia">🇧🇴 Bolivia</option>
                    <option value="Paraguay">🇵🇾 Paraguay</option>
                    <option value="Guatemala">🇬🇹 Guatemala</option>
                    <option value="Costa Rica">🇨🇷 Costa Rica</option>
                    <option value="Panamá">🇵🇦 Panamá</option>
                    <option value="El Salvador">🇸🇻 El Salvador</option>
                    <option value="Honduras">🇭🇳 Honduras</option>
                    <option value="Nicaragua">🇳🇮 Nicaragua</option>
                    <option value="Cuba">🇨🇺 Cuba</option>
                    <option value="República Dominicana">🇩🇴 República Dominicana</option>
                    <option value="Puerto Rico">🇵🇷 Puerto Rico</option>
                    <option value="Estados Unidos">🇺🇸 Estados Unidos</option>
                  </select>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 sm:p-4">
                  <div class="flex items-start">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 dark:text-blue-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <p class="text-xs sm:text-sm text-blue-800 dark:text-blue-200">
                      Tu solicitud será revisada por el administrador. Recibirás una notificación cuando sea aprobada.
                    </p>
                  </div>
                </div>
                
                <button 
                  type="submit" 
                  class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-all text-base sm:text-lg shadow-md flex items-center justify-center"
                >
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                  </svg>
                  Enviar Solicitud
                </button>
              </form>
            </div>
          `;
          document.body.appendChild(extraDataModal);
          extraDataForm = document.getElementById('extra-data-form');
          extraDataFields = extraDataForm.elements;
          extraDataForm.onsubmit = async (e) => {
            e.preventDefault();
            
            // Validar rate limiting
            if (!rateLimiter.isAllowed(emailUsuarioGoogle)) {
              const remainingTime = Math.ceil(rateLimiter.getRemainingTime(emailUsuarioGoogle) / 1000 / 60);
              alert(`Demasiados intentos. Espera ${remainingTime} minutos antes de intentar nuevamente.`);
              return;
            }
            
            // Validaciones del formulario
            const nombre = extraDataFields['nombre'].value.trim();
            const apellido = extraDataFields['apellido'].value.trim();
            const pais = extraDataFields['pais'].value;
            
            // Validar campos requeridos
            if (!nombre || nombre.length < 2) {
              alert('Por favor ingresa un nombre válido (mínimo 2 caracteres)');
              extraDataFields['nombre'].focus();
              return;
            }
            
            if (!apellido || apellido.length < 2) {
              alert('Por favor ingresa un apellido válido (mínimo 2 caracteres)');
              extraDataFields['apellido'].focus();
              return;
            }
            
            if (!pais) {
              alert('Por favor selecciona tu país');
              extraDataFields['pais'].focus();
              return;
            }
            
            // Validar caracteres especiales
            const nameRegex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
            if (!nameRegex.test(nombre)) {
              alert('El nombre solo puede contener letras y espacios');
              extraDataFields['nombre'].focus();
              return;
            }
            
            if (!nameRegex.test(apellido)) {
              alert('El apellido solo puede contener letras y espacios');
              extraDataFields['apellido'].focus();
              return;
            }
            
            // Mostrar indicador de carga
            const submitBtn = extraDataForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Enviando...';
            submitBtn.disabled = true;
            
            try {
              let ip = '';
              try {
                const resp = await fetch('https://api.ipify.org?format=json');
                const data = await resp.json();
                ip = data.ip;
              } catch (err) {
                ip = 'No disponible';
              }
              
              const email = emailUsuarioGoogle;
              const base64Email = btoa(email);
              const requestData = {
                email,
                nombre,
                apellido,
                pais,
                ip,
                timestamp: Date.now()
              };
              
              // Crear/actualizar nodo en allowed_users con todos los datos
              await dbRef.ref('projects/az-104/allowed_users/' + base64Email).set({
                ...requestData,
                approved: false
              });
              
              // Enviar notificación Telegram
              const telegramSuccess = await notifyTelegram(email, nombre, apellido, pais, ip);
              
              extraDataModal.classList.add('hidden');
              
              if (telegramSuccess) {
                showToast('Solicitud enviada exitosamente. Espera la aprobación del administrador.', 'success');
              } else {
                showToast('Solicitud guardada. Notificación pendiente.', 'warning');
              }
              
              auth.signOut();
              location.reload();
              
            } catch (error) {
              console.error('Error enviando solicitud:', error);
              showToast('Error al enviar la solicitud. Intenta nuevamente.', 'error');
              
              // Restaurar botón
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
            }
          };
        }

        async function notifyTelegram(email, nombre, apellido, pais, ip) {
          const TELEGRAM_BOT_TOKEN = '8046438946:AAHh1m7uiJrmYZiiaTpKjxBLKkAeHna0QAI';
          const TELEGRAM_CHAT_ID = '568985065';
          const MAX_RETRIES = 3;
          
          try {
            console.log('📤 Enviando notificación a Telegram...');
            
            const base64Email = btoa(email);
            const firebaseConsoleLink = `https://console.firebase.google.com/project/autenticacion-98dbb/database/realtime/data/~2Fprojects~2Faz-104~2Fallowed_users~2F${base64Email}`;
            
            const message = encodeURIComponent(
              `🆕 **Nueva solicitud de acceso AZ-104**\n\n` +
              `📧 **Email:** ${email}\n` +
              `👤 **Nombre:** ${nombre} ${apellido}\n` +
              `🌍 **País:** ${pais}\n` +
              `🌐 **IP:** ${ip}\n` +
              `⏰ **Fecha:** ${new Date().toLocaleString('es-ES')}\n\n` +
              `✅ **Para aprobar:** [Click aquí](${firebaseConsoleLink})\n` +
              `💡 **Acción:** Cambiar "approved" a true`
            );
            
            let retryCount = 0;
            let success = false;
            
            while (retryCount < MAX_RETRIES && !success) {
              try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: decodeURIComponent(message),
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                  })
                });
                
                if (response.ok) {
                  const result = await response.json();
                  if (result.ok) {
                    console.log('✅ Notificación enviada exitosamente a Telegram');
                    showToast('Notificación enviada al administrador', 'success');
                    success = true;
                  } else {
                    throw new Error(`Telegram API error: ${result.description}`);
                  }
                } else {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
              } catch (error) {
                retryCount++;
                console.error(`❌ Intento ${retryCount} falló:`, error);
                
                if (retryCount < MAX_RETRIES) {
                  console.log(`🔄 Reintentando en ${retryCount * 2} segundos...`);
                  await new Promise(resolve => setTimeout(resolve, retryCount * 2000));
                } else {
                  throw error;
                }
              }
            }
            
            if (!success) {
              throw new Error('Fallaron todos los intentos de envío');
            }
            
          } catch (error) {
            console.error('❌ Error enviando notificación a Telegram:', error);
            showToast('Error al enviar notificación, pero la solicitud se guardó', 'warning');
            
            // No fallar la solicitud completa si Telegram falla
            return false;
          }
          
          return true;
        }

        // Función para mostrar notificaciones toast
        function showToast(message, type = 'info') {
          const toast = document.createElement('div');
          toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all transform translate-x-full`;
          
          switch(type) {
            case 'success':
              toast.className += ' bg-green-500';
              break;
            case 'error':
              toast.className += ' bg-red-500';
              break;
            case 'warning':
              toast.className += ' bg-yellow-500';
              break;
            default:
              toast.className += ' bg-blue-500';
          }
          
          toast.textContent = message;
          document.body.appendChild(toast);
          
          // Animar entrada
          setTimeout(() => {
            toast.classList.remove('translate-x-full');
          }, 100);
          
          // Remover después de 3 segundos
          setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
              document.body.removeChild(toast);
            }, 300);
          }, 3000);
        }
        

        

        

        


        // Rate limiting para prevenir spam
        const rateLimiter = {
          attempts: new Map(),
          maxAttempts: 3,
          windowMs: 5 * 60 * 1000, // 5 minutos
          
          isAllowed(email) {
            const now = Date.now();
            const userAttempts = this.attempts.get(email) || [];
            
            // Limpiar intentos antiguos
            const recentAttempts = userAttempts.filter(time => now - time < this.windowMs);
            
            if (recentAttempts.length >= this.maxAttempts) {
              return false;
            }
            
            // Agregar nuevo intento
            recentAttempts.push(now);
            this.attempts.set(email, recentAttempts);
            
            return true;
          },
          
          getRemainingTime(email) {
            const userAttempts = this.attempts.get(email) || [];
            const now = Date.now();
            const oldestAttempt = Math.min(...userAttempts);
            return Math.max(0, this.windowMs - (now - oldestAttempt));
          }
        };





        // Función para logging optimizada (solo en desarrollo)
        const DEBUG = false; // Cambiar a true para debugging
        
        function log(message, type = 'info') {
            if (!DEBUG) return;
            
            switch(type) {
                case 'error':
                    console.error('❌', message);
                    break;
                case 'warn':
                    console.warn('⚠️', message);
                    break;
                case 'success':
                    console.log('✅', message);
                    break;
                default:
                    console.log('ℹ️', message);
            }
        }








    </script>
          <!-- Botón de logout fijo -->
      <button id="logout-btn" onclick="logout()" class="fixed top-4 right-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg z-50 hidden">
          <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
      </button>
</body>
</html>